I"ğF<h3 id="å‰è¨€"><strong>å‰è¨€</strong></h3>
<p>ç†Ÿæ‚‰androidæºç çš„åŒå­¦åº”è¯¥çŸ¥é“HttpUrlConnectionçš„åº•å±‚å®ç°ä»android4.4å¼€å§‹å°±ç”±httpclient <br />
æ›¿æ¢æˆäº†okhttpã€‚æ‰€ä»¥åœ¨åˆ†æHttpUrlConnectionæºç çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯åœ¨é˜…è¯»okhttpçš„æºç ã€‚åˆ†æçš„æ–¹æ³• <br />
æ˜¯å…ˆç”»å‡ºæ—¶åºå›¾ï¼Œç„¶åç»“åˆæ—¶åºå›¾å»åˆ†æå…³é”®æ–¹æ³•ä¸­çš„å…³é”®ä»£ç ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="s">"http://yoururl.com"</span><span class="o">);</span>
<span class="nc">HttpsURLConnection</span> <span class="n">conn</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpsURLConnection</span><span class="o">)</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">15000</span><span class="o">);</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setDoInput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">NameValuePair</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">NameValuePair</span><span class="o">&gt;();</span>
<span class="n">params</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BasicNameValuePair</span><span class="o">(</span><span class="s">"firstParam"</span><span class="o">,</span> <span class="n">paramValue1</span><span class="o">));</span>
<span class="n">params</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BasicNameValuePair</span><span class="o">(</span><span class="s">"secondParam"</span><span class="o">,</span> <span class="n">paramValue2</span><span class="o">));</span>
<span class="n">params</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BasicNameValuePair</span><span class="o">(</span><span class="s">"thirdParam"</span><span class="o">,</span> <span class="n">paramValue3</span><span class="o">));</span>

<span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
<span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="n">os</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">));</span>
<span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">getQuery</span><span class="o">(</span><span class="n">params</span><span class="o">));</span>
<span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

<span class="n">conn</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span></code></pre></figure>

<p>æœ¬æ–‡åŸºäºandroid4.4.4æºç åˆ†æï¼Œå„ä¸ªç‰ˆæœ¬ä»£ç ç•¥æœ‰ä¸åŒã€‚</p>

<hr />

<h3 id="æ—¶åºå›¾"><strong>æ—¶åºå›¾</strong></h3>
<p><img src="/assets/images/2021-pic/p4.png" alt="p" /></p>

<h3 id="å…³é”®æ–¹æ³•"><strong>å…³é”®æ–¹æ³•</strong></h3>
<p><strong>1.new URL(String spec)</strong>
<img src="/assets/images/2021-pic/p1.jpg" alt="p1" /></p>

<p><strong>2.setupStreamHandler()</strong>
<img src="/assets/images/2021-pic/p2.png" alt="p" /><br />
å¯ä»¥çœ‹åˆ°é€‰æ‹©çš„æ˜¯HttpHandler</p>

<p><strong>13.initHttpEngine()</strong>
<img src="/assets/images/2021-pic/p3.png" alt="p" /></p>

<p><strong>14.execute(false)</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * Sends a request and optionally reads a response. Returns true if the
 * request was successfully executed, and false if the request can be
 * retried. Throws an exception if the request failed permanently.
 */</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">execute</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">readResponse</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">httpEngine</span><span class="o">.</span><span class="na">sendRequest</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">readResponse</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">httpEngine</span><span class="o">.</span><span class="na">readResponse</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p><strong>15.sendRequest()</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">sendRequest</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="n">prepareRawRequestHeaders</span><span class="o">();</span> <span class="c1">// åŠ è½½å¸¸ç”¨å¤´éƒ¨ï¼Œ"Keep-Alive"ï¼Œ"gzip"ç­‰ï¼ŒåŠ è½½cookie</span>
  <span class="n">initResponseSource</span><span class="o">();</span>
  <span class="nc">OkResponseCache</span> <span class="n">responseCache</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getOkResponseCache</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">responseCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">responseCache</span><span class="o">.</span><span class="na">trackResponse</span><span class="o">(</span><span class="n">responseSource</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// The raw response source may require the network, but the request</span>
  <span class="c1">// headers may forbid network use. In that case, dispose of the network</span>
  <span class="c1">// response and use a GATEWAY_TIMEOUT response instead, as specified</span>
  <span class="c1">// by http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9.4.</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">requestHeaders</span><span class="o">.</span><span class="na">isOnlyIfCached</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">responseSource</span><span class="o">.</span><span class="na">requiresConnection</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span> <span class="o">==</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">CONDITIONAL_CACHE</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">cachedResponseBody</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">responseSource</span> <span class="o">=</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">CACHE</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cacheResponse</span> <span class="o">=</span> <span class="no">GATEWAY_TIMEOUT_RESPONSE</span><span class="o">;</span>
    <span class="nc">RawHeaders</span> <span class="n">rawResponseHeaders</span> <span class="o">=</span> <span class="nc">RawHeaders</span><span class="o">.</span><span class="na">fromMultimap</span><span class="o">(</span><span class="n">cacheResponse</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">setResponse</span><span class="o">(</span><span class="k">new</span> <span class="nc">ResponseHeaders</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">rawResponseHeaders</span><span class="o">),</span> <span class="n">cacheResponse</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span><span class="o">.</span><span class="na">requiresConnection</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">sendSocketRequest</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">client</span><span class="o">.</span><span class="na">getConnectionPool</span><span class="o">().</span><span class="na">recycle</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>prepareRawRequestHeaders(); // åŠ è½½å¸¸ç”¨å¤´éƒ¨ï¼Œâ€Keep-Aliveâ€ï¼Œâ€gzipâ€ç­‰ï¼ŒåŠ è½½cookie</p>

<p>ä»”ç»†çœ‹ä¸‹initResponseSource()çš„æºç </p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * Initialize the source for this response. It may be corrected later if the
 * request headers forbids network use.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">initResponseSource</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
  <span class="n">responseSource</span> <span class="o">=</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">NETWORK</span><span class="o">;</span> <span class="c1">// è®¾ç½®responseSourceä¸ºä»ç½‘ç»œè·å–</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">policy</span><span class="o">.</span><span class="na">getUseCaches</span><span class="o">())</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// ç¦æ­¢ä½¿ç”¨ç¼“å­˜ï¼Œreturn</span>

  <span class="nc">OkResponseCache</span> <span class="n">responseCache</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getOkResponseCache</span><span class="o">();</span> <span class="c1">// è·å–æœ¬åœ°ç¼“å­˜</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">responseCache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span> <span class="c1">// ç¼“å­˜ä¸ºç©ºï¼Œåˆ™è¿”å›</span>

  <span class="nc">CacheResponse</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">responseCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span>
      <span class="n">uri</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">requestHeaders</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">toMultimap</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span> <span class="c1">// æ ¹æ®uri,methodä½œä¸ºkey,è·å–cacheå€™é€‰äºº</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">candidate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>

  <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">responseHeadersMap</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">();</span> <span class="c1">// è·å–ç¼“å­˜çš„å¤´éƒ¨</span>
  <span class="n">cachedResponseBody</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span> <span class="c1">// è·å–ç¼“å­˜çš„èº«éƒ¨</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">acceptCacheResponseType</span><span class="o">(</span><span class="n">candidate</span><span class="o">)</span>
      <span class="o">||</span> <span class="n">responseHeadersMap</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">||</span> <span class="n">cachedResponseBody</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">cachedResponseBody</span><span class="o">);</span> <span class="c1">// å…³é—­cachedResponseBodyè¿™ä¸ªinputStream</span>
    <span class="k">return</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nc">RawHeaders</span> <span class="n">rawResponseHeaders</span> <span class="o">=</span> <span class="nc">RawHeaders</span><span class="o">.</span><span class="na">fromMultimap</span><span class="o">(</span><span class="n">responseHeadersMap</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="n">cachedResponseHeaders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ResponseHeaders</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">rawResponseHeaders</span><span class="o">);</span>
  <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
  <span class="k">this</span><span class="o">.</span><span class="na">responseSource</span> <span class="o">=</span> <span class="n">cachedResponseHeaders</span><span class="o">.</span><span class="na">chooseResponseSource</span><span class="o">(</span><span class="n">now</span><span class="o">,</span> <span class="n">requestHeaders</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span> <span class="o">==</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">CACHE</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// å¦‚æœæ˜¯ç¼“å­˜ç±»å‹ï¼Œç›´æ¥setResponse</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cacheResponse</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">;</span>
    <span class="n">setResponse</span><span class="o">(</span><span class="n">cachedResponseHeaders</span><span class="o">,</span> <span class="n">cachedResponseBody</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span> <span class="o">==</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">CONDITIONAL_CACHE</span><span class="o">)</span> <span class="o">{</span> <span class="c1">//å¦‚æœæ˜¯éœ€è¦éªŒè¯çš„ç¼“å­˜ç±»å‹ï¼Œåˆ™åªæ˜¯è®°å½•cacheResponse</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cacheResponse</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">;</span>
  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">responseSource</span> <span class="o">==</span> <span class="nc">ResponseSource</span><span class="o">.</span><span class="na">NETWORK</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// ä¸æ”¯æŒç¼“å­˜ï¼Œå…³é—­cachedResponseBodyè¿™ä¸ªinputStream</span>
    <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">cachedResponseBody</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">AssertionError</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>client.getOkResponseCache()æºç åˆ†æï¼Œå…¶ä¸­clientæ˜¯okHttpClient</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nc">OkResponseCache</span> <span class="nf">getOkResponseCache</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">responseCache</span> <span class="k">instanceof</span> <span class="nc">HttpResponseCache</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">((</span><span class="nc">HttpResponseCache</span><span class="o">)</span> <span class="n">responseCache</span><span class="o">).</span><span class="na">okResponseCache</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">responseCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">OkResponseCacheAdapter</span><span class="o">(</span><span class="n">responseCache</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">HttpResponseCache</span> <span class="kd">extends</span> <span class="nc">ResponseCache</span> <span class="kd">implements</span> <span class="nc">Closeable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">HttpResponseCache</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span> <span class="n">delegate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Returns the currently-installed {@code HttpResponseCache}, or null if
     * there is no cache installed or it is not a {@code HttpResponseCache}.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">HttpResponseCache</span> <span class="nf">getInstalled</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ResponseCache</span> <span class="n">installed</span> <span class="o">=</span> <span class="nc">ResponseCache</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">installed</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpResponseCache</span><span class="o">(</span>
                    <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span><span class="o">)</span> <span class="n">installed</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Creates a new HTTP response cache and {@link ResponseCache#setDefault
     * sets it} as the system default cache.
     *
     * @param directory the directory to hold cache data.
     * @param maxSize the maximum size of the cache in bytes.
     * @return the newly-installed cache
     * @throws IOException if {@code directory} cannot be used for this cache.
     *     Most applications should respond to this exception by logging a
     *     warning.
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">HttpResponseCache</span> <span class="nf">install</span><span class="o">(</span><span class="nc">File</span> <span class="n">directory</span><span class="o">,</span> <span class="kt">long</span> <span class="n">maxSize</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ResponseCache</span> <span class="n">installed</span> <span class="o">=</span> <span class="nc">ResponseCache</span><span class="o">.</span><span class="na">getDefault</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">installed</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span> <span class="n">installedCache</span> <span class="o">=</span>
                    <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span><span class="o">)</span> <span class="n">installed</span><span class="o">;</span>
            <span class="c1">// don't close and reopen if an equivalent cache is already installed</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">installedCache</span><span class="o">.</span><span class="na">getDirectory</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">directory</span><span class="o">)</span>
                    <span class="o">&amp;&amp;</span> <span class="n">installedCache</span><span class="o">.</span><span class="na">getMaxSize</span><span class="o">()</span> <span class="o">==</span> <span class="n">maxSize</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">installedCache</span><span class="o">.</span><span class="na">isClosed</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpResponseCache</span><span class="o">(</span><span class="n">installedCache</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// The HttpResponseCache that owns this object is about to be replaced.</span>
                <span class="n">installedCache</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span> <span class="n">responseCache</span> <span class="o">=</span>
                <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">okhttp</span><span class="o">.</span><span class="na">HttpResponseCache</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="n">maxSize</span><span class="o">);</span>
        <span class="nc">ResponseCache</span><span class="o">.</span><span class="na">setDefault</span><span class="o">(</span><span class="n">responseCache</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpResponseCache</span><span class="o">(</span><span class="n">responseCache</span><span class="o">);</span>
    <span class="o">}</span></code></pre></figure>

<p>è¿™é‡Œä½¿ç”¨äº†ä»£ç†æ¨¡å¼ï¼Œandroid.net.http.HttpResponseCacheå¯¹è±¡ä»£ç†äº†com.squareup.okhttp.HttpResponseCache
å¯¹è±¡ï¼ŒçœŸæ­£çš„å®ç°ç±»æ˜¯ç”±com.squareup.okhttp.HttpResponseCacheå®Œæˆã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
   * Although this class only exposes the limited ResponseCache API, it
   * implements the full OkResponseCache interface. This field is used as a
   * package private handle to the complete implementation. It delegates to
   * public and private members of this type.
   */</span>
  <span class="kd">final</span> <span class="nc">OkResponseCache</span> <span class="n">okResponseCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OkResponseCache</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">CacheResponse</span> <span class="nf">get</span><span class="o">(</span><span class="no">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="nc">String</span> <span class="n">requestMethod</span><span class="o">,</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">requestHeaders</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">requestMethod</span><span class="o">,</span> <span class="n">requestHeaders</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">CacheRequest</span> <span class="nf">put</span><span class="o">(</span><span class="no">URI</span> <span class="n">uri</span><span class="o">,</span> <span class="nc">URLConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maybeRemove</span><span class="o">(</span><span class="nc">String</span> <span class="n">requestMethod</span><span class="o">,</span> <span class="no">URI</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">maybeRemove</span><span class="o">(</span><span class="n">requestMethod</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span>
        <span class="nc">CacheResponse</span> <span class="n">conditionalCacheHit</span><span class="o">,</span> <span class="nc">HttpURLConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
      <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">conditionalCacheHit</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">trackConditionalCacheHit</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">trackConditionalCacheHit</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">trackResponse</span><span class="o">(</span><span class="nc">ResponseSource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">HttpResponseCache</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">trackResponse</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">};</span>

  <span class="kd">public</span> <span class="nf">HttpResponseCache</span><span class="o">(</span><span class="nc">File</span> <span class="n">directory</span><span class="o">,</span> <span class="kt">long</span> <span class="n">maxSize</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span> <span class="c1">// HttpResponseCacheä½¿ç”¨ç¡¬ç›˜ä½œä¸ºç¼“å­˜ä»‹è´¨</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="nc">DiskLruCache</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">directory</span><span class="o">,</span> <span class="no">VERSION</span><span class="o">,</span> <span class="no">ENTRY_COUNT</span><span class="o">,</span> <span class="n">maxSize</span><span class="o">);</span>
  <span class="o">}</span></code></pre></figure>

<p>å¯ä»¥çœ‹å‡ºokResponseCacheä»£ç†äº†HttpResponseCache.thisï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼ã€‚æ‰€ä»¥çœŸæ­£å¹²äº‹çš„è¿˜æ˜¯com.squareup.okhttp.HttpResponseCache.<br />
ç»§ç»­çœ‹initResponseSource()ä»£ç ï¼Œä»£ç çš„æ³¨é‡Šå·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†ã€‚åŸºæœ¬å°±æ˜¯ç¼“å­˜æœ‰æ•ˆï¼Œå°±èµ‹å€¼ç»™HttpEngineçš„cacheResponse field.</p>

<p><strong>18.RouteSelector.next()</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nc">Connection</span> <span class="nf">next</span><span class="o">(</span><span class="nc">String</span> <span class="n">method</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
   <span class="c1">// Always prefer pooled connections over new connections.</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">pooled</span><span class="o">;</span> <span class="o">(</span><span class="n">pooled</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">address</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"GET"</span><span class="o">)</span> <span class="o">||</span> <span class="n">pooled</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="k">return</span> <span class="n">pooled</span><span class="o">;</span>
     <span class="n">pooled</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="c1">// Compute the next route to attempt.</span>
   <span class="c1">// è¿™ä¸€æ®µä»£ç é‡Œæ¯”è¾ƒç»•ï¼Œå„ç§boolå€¼æ¥æ§åˆ¶ç¨‹åºæµå‘ï¼Œå…·ä½“è¦ä»”ç»†çœ‹ä»£ç ï¼Œä½†æ˜¯æ²¡æœ‰å¤ªå¤§æ„ä¹‰ã€‚</span>
   <span class="c1">// å…·ä½“æ¥è¯´å°±æ˜¯å®ç°äº†å¤šhost,å¤šä»£ç†çš„å¾ªç¯å°è¯•æ–¹æ¡ˆã€‚åœ¨åç»­çš„é€’å½’next(method)è¿›è¡Œé€’å½’å°è¯•ã€‚</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">hasNextTlsMode</span><span class="o">())</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(!</span><span class="n">hasNextInetSocketAddress</span><span class="o">())</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(!</span><span class="n">hasNextProxy</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">hasNextPostponed</span><span class="o">())</span> <span class="o">{</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">Connection</span><span class="o">(</span><span class="n">nextPostponed</span><span class="o">());</span>
       <span class="o">}</span>
       <span class="n">lastProxy</span> <span class="o">=</span> <span class="n">nextProxy</span><span class="o">();</span>
       <span class="n">resetNextInetSocketAddress</span><span class="o">(</span><span class="n">lastProxy</span><span class="o">);</span>
     <span class="o">}</span>
     <span class="n">lastInetSocketAddress</span> <span class="o">=</span> <span class="n">nextInetSocketAddress</span><span class="o">();</span>
     <span class="n">resetNextTlsMode</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kt">boolean</span> <span class="n">modernTls</span> <span class="o">=</span> <span class="n">nextTlsMode</span><span class="o">()</span> <span class="o">==</span> <span class="no">TLS_MODE_MODERN</span><span class="o">;</span>
   <span class="nc">Route</span> <span class="n">route</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Route</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">lastProxy</span><span class="o">,</span> <span class="n">lastInetSocketAddress</span><span class="o">,</span> <span class="n">modernTls</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">routeDatabase</span><span class="o">.</span><span class="na">shouldPostpone</span><span class="o">(</span><span class="n">route</span><span class="o">))</span> <span class="o">{</span>
     <span class="n">postponedRoutes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>
     <span class="c1">// We will only recurse in order to skip previously failed routes. They will be</span>
     <span class="c1">// tried last.</span>
     <span class="k">return</span> <span class="nf">next</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">return</span> <span class="k">new</span> <span class="nf">Connection</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>
 <span class="o">}</span></code></pre></figure>

<p>å…ˆçœ‹pooled.isReadable()çš„æºç ï¼Œpooledæ˜¯Connectionå®ä¾‹</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
   * Returns true if we are confident that we can read data from this
   * connection. This is more expensive and more accurate than {@link
   * #isAlive()}; callers should check {@link #isAlive()} first.
   */</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isReadable</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">in</span> <span class="k">instanceof</span> <span class="nc">BufferedInputStream</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Optimistic.</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isSpdy</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Optimistic. We can't test SPDY because its streams are in use.</span>
    <span class="o">}</span>
    <span class="nc">BufferedInputStream</span> <span class="n">bufferedInputStream</span> <span class="o">=</span> <span class="o">(</span><span class="nc">BufferedInputStream</span><span class="o">)</span> <span class="n">in</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">readTimeout</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getSoTimeout</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">bufferedInputStream</span><span class="o">.</span><span class="na">mark</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">bufferedInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Stream is exhausted; socket is closed.</span>
        <span class="o">}</span>
        <span class="n">bufferedInputStream</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketTimeoutException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">// Read timed out; socket is good.</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// Couldn't read; socket is closed.</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></figure>

<p>isReadableè°ƒç”¨bufferedInputStream.mark(1)ï¼Œç„¶åå»è¯»bufferedInputStream,çœ‹æ˜¯å¦è¶…æ—¶æ¥åˆ¤æ–­connectionçš„in fieldæ˜¯å¦å¯è¯»ã€‚ <br />
åç»­çš„ä¸€ç³»åˆ—ifè¯­å¥çš„ä½œç”¨ï¼Œæˆ‘åœ¨ä»£ç çš„æ³¨é‡Šé‡Œï¼Œå·²ç»å†™çš„å¾ˆæ¸…æ¥šäº†ã€‚</p>

<p><strong>20.Connection.connect()</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">,</span> <span class="kt">int</span> <span class="n">readTimeout</span><span class="o">,</span> <span class="nc">TunnelRequest</span> <span class="n">tunnelRequest</span><span class="o">)</span>
     <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">connected</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"already connected"</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">connected</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
   <span class="n">socket</span> <span class="o">=</span> <span class="o">(</span><span class="n">route</span><span class="o">.</span><span class="na">proxy</span><span class="o">.</span><span class="na">type</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">HTTP</span><span class="o">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="n">route</span><span class="o">.</span><span class="na">proxy</span><span class="o">)</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">();</span>
   <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">connectSocket</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">route</span><span class="o">.</span><span class="na">inetSocketAddress</span><span class="o">,</span> <span class="n">connectTimeout</span><span class="o">);</span>
   <span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">readTimeout</span><span class="o">);</span>
   <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
   <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">route</span><span class="o">.</span><span class="na">address</span><span class="o">.</span><span class="na">sslSocketFactory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">upgradeToTls</span><span class="o">(</span><span class="n">tunnelRequest</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="c1">// Use MTU-sized buffers to send fewer packets.</span>
   <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getMtu</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="o">)</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="o">)</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">8192</span><span class="o">;</span>
   <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="n">mtu</span><span class="o">);</span>
   <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">mtu</span><span class="o">);</span>
 <span class="o">}</span></code></pre></figure>

<p>å°±æ˜¯ç®€å•çš„ç½‘ç»œç¼–ç¨‹çŸ¥è¯†äº†ï¼Œä»socketé‡Œè·å–inputStreamå’ŒoutputStreamã€‚</p>

<p><strong>17.HttpEngine.connect()</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">connect</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">connection</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">routeSelector</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">String</span> <span class="n">uriHost</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="na">getHost</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">uriHost</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnknownHostException</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
     <span class="o">}</span>
     <span class="nc">SSLSocketFactory</span> <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="nc">HostnameVerifier</span> <span class="n">hostnameVerifier</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getScheme</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"https"</span><span class="o">))</span> <span class="o">{</span>
       <span class="n">sslSocketFactory</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getSslSocketFactory</span><span class="o">();</span>
       <span class="n">hostnameVerifier</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getHostnameVerifier</span><span class="o">();</span>
     <span class="o">}</span>
     <span class="nc">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Address</span><span class="o">(</span><span class="n">uriHost</span><span class="o">,</span> <span class="n">getEffectivePort</span><span class="o">(</span><span class="n">uri</span><span class="o">),</span> <span class="n">sslSocketFactory</span><span class="o">,</span>
         <span class="n">hostnameVerifier</span><span class="o">,</span> <span class="n">client</span><span class="o">.</span><span class="na">getAuthenticator</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">getTransports</span><span class="o">());</span>
     <span class="n">routeSelector</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RouteSelector</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">uri</span><span class="o">,</span> <span class="n">client</span><span class="o">.</span><span class="na">getProxySelector</span><span class="o">(),</span>
         <span class="n">client</span><span class="o">.</span><span class="na">getConnectionPool</span><span class="o">(),</span> <span class="nc">Dns</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">,</span> <span class="n">client</span><span class="o">.</span><span class="na">getRoutesDatabase</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="n">connection</span> <span class="o">=</span> <span class="n">routeSelector</span><span class="o">.</span><span class="na">next</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(!</span><span class="n">connection</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
     <span class="n">connection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getConnectTimeout</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">getReadTimeout</span><span class="o">(),</span> <span class="n">getTunnelConfig</span><span class="o">());</span>
     <span class="n">client</span><span class="o">.</span><span class="na">getConnectionPool</span><span class="o">().</span><span class="na">maybeShare</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span> <span class="c1">// connectionPoolæ·»åŠ è¿™ä¸ªè¿æ¥</span>
     <span class="n">client</span><span class="o">.</span><span class="na">getRoutesDatabase</span><span class="o">().</span><span class="na">connected</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getRoute</span><span class="o">());</span> <span class="c1">// failedRoutes.remove(route);</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="n">connection</span><span class="o">.</span><span class="na">updateReadTimeout</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getReadTimeout</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="n">connected</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getRoute</span><span class="o">().</span><span class="na">getProxy</span><span class="o">()</span> <span class="o">!=</span> <span class="n">client</span><span class="o">.</span><span class="na">getProxy</span><span class="o">())</span> <span class="o">{</span>
     <span class="c1">// Update the request line if the proxy changed; it may need a host name.</span>
     <span class="n">requestHeaders</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">setRequestLine</span><span class="o">(</span><span class="n">getRequestLine</span><span class="o">());</span>
   <span class="o">}</span>
 <span class="o">}</span></code></pre></figure>

<p>è‡ªå·±æ·»åŠ çš„ä¸­æ–‡æ³¨é‡Šå’Œgoogleå·¥ç¨‹å¸ˆçš„è‹±æ–‡æ³¨é‡Šå·²ç»å¾ˆæ¸…æ¥šäº†ã€‚æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹client.getRoutesDatabase().connected(connection.getRoute()) <br />
å…¶å®RouteDatabaseè¿™ä¸ªç±»çš„ä½œç”¨å¾ˆç®€å•ï¼Œå®ƒçš„ä½œç”¨æºç é‡Œçš„ä»‹ç»å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œå¦‚ä¸‹:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * A blacklist of failed routes to avoid when creating a new connection to a
 * target address. This is used so that OkHttp can learn from its mistakes: if
 * there was a failure attempting to connect to a specific IP address, proxy
 * server or TLS mode, that failure is remembered and alternate routes are
 * preferred.
 */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RouteDatabase</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Route</span><span class="o">&gt;</span> <span class="n">failedRoutes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashSet</span><span class="o">&lt;</span><span class="nc">Route</span><span class="o">&gt;();</span>

  <span class="cm">/** Records a failure connecting to {@code failedRoute}. */</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="nc">Route</span> <span class="n">failedRoute</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">failure</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">failedRoutes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">failedRoute</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(!(</span><span class="n">failure</span> <span class="k">instanceof</span> <span class="nc">SSLHandshakeException</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// If the problem was not related to SSL then it will also fail with</span>
      <span class="c1">// a different TLS mode therefore we can be proactive about it.</span>
      <span class="n">failedRoutes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">failedRoute</span><span class="o">.</span><span class="na">flipTlsMode</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/** Records success connecting to {@code failedRoute}. */</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">connected</span><span class="o">(</span><span class="nc">Route</span> <span class="n">route</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">failedRoutes</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/** Returns true if {@code route} has failed recently and should be avoided. */</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">boolean</span> <span class="nf">shouldPostpone</span><span class="o">(</span><span class="nc">Route</span> <span class="n">route</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">failedRoutes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">route</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">failedRoutesCount</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">failedRoutes</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><strong>ConnectionPoolä»‹ç»</strong>  <br />
ä¸­é—´ç©¿æ’ä»‹ç»ä¸‹okhttpçš„è¿æ¥ç¼“å­˜æ± çš„ä»£ç ï¼Œå°±çœ‹çœ‹å®ƒçš„æ ¸å¿ƒrecycleæ–¹æ³•</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">recycle</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">isSpdy</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// spdyæ˜¯http1.2çš„å‰èº«ï¼Œä¸»è¦å®ç°äº†ä¸€ä¸ªsocketè¿æ¥å¯¹äºå¤šä¸ªè¯·æ±‚çš„å¤šè·¯å¤ç”¨</span>
     <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(!</span><span class="n">connection</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
     <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
     <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="k">try</span> <span class="o">{</span>
     <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">untagSocket</span><span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getSocket</span><span class="o">());</span> <span class="c1">// åœæ­¢å¯¹è¯¥socketçš„ç»Ÿè®¡å·¥ä½œ</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">SocketException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// When unable to remove tagging, skip recycling and close.</span>
     <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">logW</span><span class="o">(</span><span class="s">"Unable to untagSocket(): "</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
     <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
     <span class="k">return</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">connections</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span> <span class="c1">// connectionsä¸­æ·»åŠ connection</span>
     <span class="n">connection</span><span class="o">.</span><span class="na">resetIdleStartTime</span><span class="o">();</span> <span class="c1">// é‡ç½®é—²ç½®æ—¶é—´ä¸ºå½“å‰</span>
   <span class="o">}</span>

   <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">connectionsCleanupCallable</span><span class="o">);</span> <span class="c1">// å¼€å¯æ¸…ç†ä»»åŠ¡,æ¸…ç†å¤±æ•ˆçš„è¿æ¥</span>
 <span class="o">}</span>

 <span class="cm">/** We use a single background thread to cleanup expired connections. */</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
      <span class="mi">60L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;(),</span>
      <span class="nc">Util</span><span class="o">.</span><span class="na">daemonThreadFactory</span><span class="o">(</span><span class="s">"OkHttp ConnectionPool"</span><span class="o">));</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">connectionsCleanupCallable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;</span> <span class="n">expiredConnections</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;(</span><span class="no">MAX_CONNECTIONS_TO_CLEANUP</span><span class="o">);</span>
      <span class="kt">int</span> <span class="n">idleConnectionCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">ConnectionPool</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">ListIterator</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">listIterator</span><span class="o">(</span><span class="n">connections</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="n">i</span><span class="o">.</span><span class="na">hasPrevious</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
          <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">previous</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">connection</span><span class="o">.</span><span class="na">isAlive</span><span class="o">()</span> <span class="o">||</span> <span class="n">connection</span><span class="o">.</span><span class="na">isExpired</span><span class="o">(</span><span class="n">keepAliveDurationNs</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// connectionç©ºé—²æ—¶é—´è¶…è¿‡5minï¼Œåˆ™è®¤ä¸ºè¿æ¥å¤±æ•ˆ</span>
            <span class="n">i</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="n">expiredConnections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">expiredConnections</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="no">MAX_CONNECTIONS_TO_CLEANUP</span><span class="o">)</span> <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">isIdle</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">idleConnectionCount</span><span class="o">++;</span>
          <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">ListIterator</span><span class="o">&lt;</span><span class="nc">Connection</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">connections</span><span class="o">.</span><span class="na">listIterator</span><span class="o">(</span><span class="n">connections</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
            <span class="n">i</span><span class="o">.</span><span class="na">hasPrevious</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">idleConnectionCount</span> <span class="o">&gt;</span> <span class="n">maxIdleConnections</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
          <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">previous</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">isIdle</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">expiredConnections</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
            <span class="n">i</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
            <span class="o">--</span><span class="n">idleConnectionCount</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">expiredConnection</span> <span class="o">:</span> <span class="n">expiredConnections</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Util</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">expiredConnection</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></figure>

<p><strong>21.createRequestbody</strong> <br />
è¿™æ®µä»£ç å°±æ˜¯ç»™åŒ…è£…äº†ä¸‹20æ­¥ä¸­connectionè¿”å›çš„outputStream,å¹¶ä¸”æŠŠè¯·æ±‚å¤´éƒ¨å†™å…¥äº†ã€‚</p>

<p><strong>22.OutputStream os = conn.getOutputStream()</strong>  <br />
è¿™ä¸€æ­¥å°±æ˜¯ç»™21æ­¥ä¸­å°è£…çš„socket outputStreanmå¡«å……æ•°æ®äº†ã€‚å…·ä½“æ€ä¹ˆå¡«å……ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« å¼€å¤´çš„ä¾‹å­ã€‚</p>

<p><strong>30.HttpTransport.getTransferStream()</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getTransferStream</span><span class="o">(</span><span class="nc">CacheRequest</span> <span class="n">cacheRequest</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">httpEngine</span><span class="o">.</span><span class="na">hasResponseBody</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">FixedLengthInputStream</span><span class="o">(</span><span class="n">socketIn</span><span class="o">,</span> <span class="n">cacheRequest</span><span class="o">,</span> <span class="n">httpEngine</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">httpEngine</span><span class="o">.</span><span class="na">responseHeaders</span><span class="o">.</span><span class="na">isChunked</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">ChunkedInputStream</span><span class="o">(</span><span class="n">socketIn</span><span class="o">,</span> <span class="n">cacheRequest</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">httpEngine</span><span class="o">.</span><span class="na">responseHeaders</span><span class="o">.</span><span class="na">getContentLength</span><span class="o">()</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">FixedLengthInputStream</span><span class="o">(</span><span class="n">socketIn</span><span class="o">,</span> <span class="n">cacheRequest</span><span class="o">,</span> <span class="n">httpEngine</span><span class="o">,</span>
          <span class="n">httpEngine</span><span class="o">.</span><span class="na">responseHeaders</span><span class="o">.</span><span class="na">getContentLength</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// Wrap the input stream from the connection (rather than just returning</span>
    <span class="c1">// "socketIn" directly here), so that we can control its use after the</span>
    <span class="c1">// reference escapes.</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">UnknownLengthHttpInputStream</span><span class="o">(</span><span class="n">socketIn</span><span class="o">,</span> <span class="n">cacheRequest</span><span class="o">,</span> <span class="n">httpEngine</span><span class="o">);</span>
  <span class="o">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">UnknownLengthHttpInputStream</span> <span class="kd">extends</span> <span class="nc">AbstractHttpInputStream</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">inputExhausted</span><span class="o">;</span>

  <span class="nc">UnknownLengthHttpInputStream</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="nc">CacheRequest</span> <span class="n">cacheRequest</span><span class="o">,</span> <span class="nc">HttpEngine</span> <span class="n">httpEngine</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">httpEngine</span><span class="o">,</span> <span class="n">cacheRequest</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">checkOffsetAndCount</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="n">checkNotClosed</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">inputExhausted</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">inputExhausted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="n">endOfInput</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">cacheWrite</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">read</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">read</span><span class="o">;</span>
  <span class="o">}</span></code></pre></figure>

<p><strong>å¯ä»¥çœ‹åˆ°åœ¨è¿”å›inputStreamæ—¶ï¼Œä½¿ç”¨äº†è£…é¥°è€…æ¨¡å¼ã€‚å®é™…ä¸Šè¯»å–æ•°æ®åªéœ€è¦socketInè¿™ä¸ªinputstream,UnknownLengthHttpInputStreamè¿™ä¸ªåŒ…è£…ç±»çš„</strong>
<strong>readæ–¹æ³•ä¼šè°ƒç”¨cacheWriteã€‚å³ç”¨æˆ·åœ¨è¯»å–responseçš„åŒæ—¶ï¼Œæˆ‘ä»¬å°†responseçš„bodyç¼“å­˜åˆ°äº†æœ¬åœ°æ–‡ä»¶ä¸­ã€‚æ­¤åˆ»æˆ‘ä»¬å°±å®Œæˆäº†ç½‘ç»œè¯·æ±‚çš„æœ¬åœ°ç¼“å­˜åŠŸèƒ½ã€‚</strong></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">AbstractHttpInputStream</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span><span class="o">,</span> <span class="nc">HttpEngine</span> <span class="n">httpEngine</span><span class="o">,</span> <span class="nc">CacheRequest</span> <span class="n">cacheRequest</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">in</span> <span class="o">=</span> <span class="n">in</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">httpEngine</span> <span class="o">=</span> <span class="n">httpEngine</span><span class="o">;</span>

    <span class="nc">OutputStream</span> <span class="n">cacheBody</span> <span class="o">=</span> <span class="n">cacheRequest</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">cacheRequest</span><span class="o">.</span><span class="na">getBody</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">// some apps return a null body; for compatibility we treat that like a null cache request</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cacheBody</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">cacheRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">cacheBody</span> <span class="o">=</span> <span class="n">cacheBody</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">cacheRequest</span> <span class="o">=</span> <span class="n">cacheRequest</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">cacheWrite</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cacheBody</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">cacheBody</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre></figure>

<p>è¿™é‡Œçš„cacheRequestå°±æ˜¯ç¬¬28æ­¥è¿”å›çš„CacheRequestImplå®ä¾‹ã€‚
è€Œç¬¬29æ­¥çš„initContentStreamå°±æ˜¯ç»™responseBodyInèµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°çš„åŒ…è£…ç±»UnknownLengthHttpInputStreamã€‚
<strong>ç”¨æˆ·è°ƒç”¨conn.getInputStreamè°ƒç”¨çš„å°±æ˜¯HttpEngine.getResponseBody,å³è¿”å›responseBodyInã€‚</strong></p>

<p><strong>æœ€åå…³äºå¦‚ä½•åˆ¤æ–­ç¼“å­˜æœ‰æ•ˆè¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ç”¨url+å“åº”varyå¤´éƒ¨ä½œä¸ºhash keyæ¥æŸ¥æ‰¾æœ¬åœ°çš„ç¼“å­˜ï¼Œè‡³äºæ˜¯å¦æœ‰æ•ˆæ˜¯é å“åº”å¤´éƒ¨çš„last-modifiedè¿™ä¸ªå­—æ®µã€‚</strong>
æºç å¦‚ä¸‹ï¼š</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">ResponseHeaders</span> <span class="n">networkResponse</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">networkResponse</span><span class="o">.</span><span class="na">headers</span><span class="o">.</span><span class="na">getResponseCode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_NOT_MODIFIED</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// The HTTP spec says that if the network's response is older than our</span>
    <span class="c1">// cached response, we may return the cache's response. Like Chrome (but</span>
    <span class="c1">// unlike Firefox), this client prefers to return the newer response.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lastModified</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="o">&amp;&amp;</span> <span class="n">networkResponse</span><span class="o">.</span><span class="na">lastModified</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="o">&amp;&amp;</span> <span class="n">networkResponse</span><span class="o">.</span><span class="na">lastModified</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">lastModified</span><span class="o">.</span><span class="na">getTime</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span></code></pre></figure>

<p>è‡³æ­¤ï¼Œæ•´ä¸ªhttpUrlConnectionå’Œå…¶å†…éƒ¨çš„okhttpå°±åˆ†æå®Œæˆäº†~</p>
:ET