I"À	<p>è®°å½•ä¸€ä¸‹æºç ä¸­çš„é‡ç‚¹ã€‚</p>

<p>åœ¨MediaPlayerServiceå‘ServiceManageræ³¨å†ŒæœåŠ¡æ—¶ï¼Œå†™å…¥Parcelå†…å®¹ï¼š
writeInt32(IPCThreadState::self()-&gt;getStrictModePolicy() | STRICT_MODE_PENALTY_GATHER);
writeString16(â€œandroid.os.IServiceManagerâ€);
writeString16(â€œmedia.playerâ€);
writeStrongBinder(new MediaPlayerService())</p>

<p>IPCThreadState::transactçš„æ ¸å¿ƒä»£ç ä¸ºIPCThreadState::waitForResponse,ä»¥åŠwaitForResponse
ä¸‹çš„talkWithDriver()æ–¹æ³•ã€‚</p>

<p>IPCThreadState::transactå…ˆå†™æ•°æ®writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL)ï¼Œ
å…¶ä¸­dataå°±å¯¹åº”ä¸Šé¢çš„Parcelã€‚ç„¶åè¿›å…¥waitForResponseï¼Œè¿›å…¥talkWithDriverã€‚</p>

<p>talkWithDriverè°ƒç”¨ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)ï¼Œbwræ˜¯è¯»å†™æ•°æ®çš„é›†åˆä½“ã€‚
å…ˆå†™æ•°æ®ï¼Œä¾æ¬¡è°ƒç”¨å†…æ ¸binder.c-&gt;ioctl-&gt;binder_thread_write,æ–°å»ºbinder_transaction_dataç»“æ„ä½“træ•°æ®ï¼Œ
trç›´æ¥å¤åˆ¶äº†bwré‡ŒmOutå†…å®¹å³å†™æ•°æ®ã€‚ç„¶ååœ¨å†…æ ¸ç©ºé—´åˆ†é…å†…å­˜binder_transaction t,tè®°å½•äº†target_proc,target_thread
ç­‰ä¿¡æ¯ï¼Œt-&gt;bufferå¤åˆ¶äº†træ•°æ®ã€‚træ˜¯ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œè€Œtæ˜¯å†…æ ¸ç©ºé—´å†…å­˜ã€‚</p>

<p>å…³é”®ä¿¡æ¯ï¼š
target_node = binder_context_mgr_node;
target_proc = target_node-&gt;proc;
target_list = &amp;target_proc-&gt;todo;
target_wait = &amp;target_proc-&gt;wait;
thread-&gt;transaction_stack = t;è¯¥threadæ˜¯ServiceManagerè¿›ç¨‹binder_get_thread()åˆ†é…ã€‚
é™„ï¼šProcessStateä½œä¸ºå…¨å±€è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œæ˜¯å•ä¾‹æ¨¡å¼å«åšgProcess.å®ƒæ˜¯ServiceManageråœ¨æ³¨å†Œæˆä¸ºbinderå¤§ç®¡å®¶æ—¶ï¼Œopen_driver()
ç”Ÿæˆfilep.è€Œfilep-&gt;procå³ä¸ºServerManagerè¿›ç¨‹ã€‚æ‰€ä»¥ServiceManageræ—¢æ˜¯æœåŠ¡ï¼Œåˆæ˜¯binderçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œéå¸¸é‡è¦ã€‚
ä¸‹æ–‡ä¸­å¤§éƒ¨åˆ†procéƒ½æ˜¯ServerManagerè¿›ç¨‹ã€‚</p>

<p>binder_thread_writeè°ƒç”¨çš„binder_transaction()åœ¨æœ€åè°ƒç”¨äº†ï¼š
  t-&gt;work.type = BINDER_WORK_TRANSACTION;
  list_add_tail(&amp;t-&gt;work.entry, target_list);
  tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;
	list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);
	if (target_wait)
		wake_up_interruptible(target_wait);</p>

<p>å…¶ä¸­target_wait=traget_proc_wait,å³ä¸ºå”¤é†’äº†ServiceManageråœ¨binder_loop()-&gt;binder_read()
æ—¶çš„ç¡çœ ã€‚ServiceManagerå¾—åˆ°ä¸Šé¢çš„tï¼Œå³å¾—åˆ°äº†æ•°æ®ã€‚</p>

<p>æ’å…¥ä»¥ä¸‹ï¼Œä¸­é—´binder_thread_read()ä¼šåˆ†åˆ«è¯»åˆ°ä¸¤ä¸ªint32çš„cmd,BR_LOOPå’ŒBR_TRANSACTION_COMPLETE</p>

<p><img src="/assets/images/2019-pic/p2.png" alt="p2" /></p>
:ET