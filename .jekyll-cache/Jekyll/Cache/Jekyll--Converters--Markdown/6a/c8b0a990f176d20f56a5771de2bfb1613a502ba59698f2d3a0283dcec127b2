I"İä<h3 id="å‰è¨€"><strong>å‰è¨€</strong></h3>
<p>scrollviewçš„æ ¸å¿ƒæ˜¯Scrollerç±»ï¼Œè¿˜æœ‰Viewçš„draw()æ–¹æ³•é‡Œè°ƒç”¨çš„computeScroll()æ–¹æ³•ã€‚ä¸€èˆ¬åœ¨è‡ªå®šä¹‰æ§ä»¶é‡Œä½¿ç”¨Scrollerç±»æ—¶ï¼Œéƒ½è¦é…åˆé‡å†™
Viewçš„computeScroll()æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹ScrollViewè¿™ä¸ªå®˜æ–¹è‡ªå®šä¹‰æ§ä»¶å®ç°çš„å…·ä½“ä»£ç ã€‚æœ¬æ–‡æºç ä½¿ç”¨android2.3.7ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬çš„ä»£ç ç»“æ„ç®€å•ï¼Œæ–¹ä¾¿åˆ†æã€‚</p>

<h3 id="onintercepttouchevent"><strong>onInterceptTouchEvent</strong></h3>
<p>ScrollViewä½œä¸ºä¸€ä¸ªviewGroupè‡ªç„¶æ˜¯è¦é‡å†™è¿™ä¸ªæ–¹æ³•æ¥å†³å®šè‡ªå·±æ˜¯å¦æ‹¦æˆªè§¦æ‘¸äº‹ä»¶å•¦ã€‚å…ˆä¸Šæºç ï¼Œå®¹æ˜“ç†è§£çš„ä»£ç å°±ç›´æ¥åœ¨æ³¨é‡Šé‡Œåˆ†æå•¦ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onInterceptTouchEvent</span><span class="o">(</span><span class="nc">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*
         * This method JUST determines whether we want to intercept the motion.
         * If we return true, onMotionEvent will be called and we do the actual
         * scrolling there.
         */</span>

        <span class="cm">/*
        * Shortcut the most recurring case: the user is in the dragging
        * state and he is moving his finger.  We want to intercept this
        * motion.
        */</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">==</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mIsBeingDragged</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MASK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">:</span> <span class="o">{</span>
                <span class="cm">/*
                 * mIsBeingDragged == false, otherwise the shortcut would have caught it. Check
                 * whether the user has moved far enough from his original down touch.
                 */</span>

                <span class="cm">/*
                * Locally do absolute value. mLastMotionY is set to the y value
                * of the down event.
                */</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">activePointerId</span> <span class="o">=</span> <span class="n">mActivePointerId</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">activePointerId</span> <span class="o">==</span> <span class="no">INVALID_POINTER</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// If we don't have a valid id, the touch down wasn't on content.</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="kd">final</span> <span class="kt">int</span> <span class="n">pointerIndex</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">findPointerIndex</span><span class="o">(</span><span class="n">activePointerId</span><span class="o">);</span>
                <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">(</span><span class="n">pointerIndex</span><span class="o">);</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">yDiff</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">mLastMotionY</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">yDiff</span> <span class="o">&gt;</span> <span class="n">mTouchSlop</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">mLastMotionY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">inChild</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">(),</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">y</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="cm">/*
                 * Remember location of down touch.
                 * ACTION_DOWN always refers to pointer index 0.
                 */</span>
                <span class="n">mLastMotionY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
                <span class="n">mActivePointerId</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getPointerId</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

                <span class="cm">/*
                * If being flinged and user touches the screen, initiate drag;
                * otherwise don't.  mScroller.isFinished should be false when
                * being flinged.
                */</span>
                <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="o">!</span><span class="n">mScroller</span><span class="o">.</span><span class="na">isFinished</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_CANCEL</span><span class="o">:</span>
            <span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
                <span class="cm">/* Release the drag */</span>
                <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">mActivePointerId</span> <span class="o">=</span> <span class="no">INVALID_POINTER</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">springBack</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">getScrollRange</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">invalidate</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_POINTER_UP</span><span class="o">:</span>
                <span class="n">onSecondaryPointerUp</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="cm">/*
        * The only time we want to intercept motion events is if we are in the
        * drag mode.
        */</span>
        <span class="k">return</span> <span class="n">mIsBeingDragged</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>ä¸‹é¢åˆ†åˆ«å¯¹actionDown,actionMove,actionUpè¿™ä¸‰ä¸ªäº‹ä»¶è¿›è¡Œåˆ†æã€‚åˆ†æå°±ä»¥æ³¨é‡Šçš„æ–¹å¼å†™åœ¨ä»£ç é‡Œå§ï¼Œä¹Ÿå¯ä»¥ç»“åˆgoogleæºè‹±æ–‡æ³¨é‡Šè¿›è¡Œç†è§£ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">((</span><span class="n">action</span> <span class="o">==</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mIsBeingDragged</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">....</span>

<span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">:</span> <span class="o">{</span>
  <span class="cm">/*
   * mIsBeingDragged == false, otherwise the shortcut would have caught it. Check
   * whether the user has moved far enough from his original down touch.
   */</span>

  <span class="cm">/*
  * Locally do absolute value. mLastMotionY is set to the y value
  * of the down event.
  */</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">activePointerId</span> <span class="o">=</span> <span class="n">mActivePointerId</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">activePointerId</span> <span class="o">==</span> <span class="no">INVALID_POINTER</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// If we don't have a valid id, the touch down wasn't on content.</span>
      <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">final</span> <span class="kt">int</span> <span class="n">pointerIndex</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">findPointerIndex</span><span class="o">(</span><span class="n">activePointerId</span><span class="o">);</span>
  <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">(</span><span class="n">pointerIndex</span><span class="o">);</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">yDiff</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">mLastMotionY</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">yDiff</span> <span class="o">&gt;</span> <span class="n">mTouchSlop</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="n">mLastMotionY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">break</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>å¦‚æœå¤„äºdragæ¨¡å¼ï¼Œæˆ‘ä»¬å¯¹äºactionMoveè¿›è¡Œæ‹¦æˆªï¼Œæ–¹ä¾¿ä¼ é€’ç»™onTouchEvent()æ¥è¿›è¡Œæ»šåŠ¨ã€‚
å¦‚æœè¿˜æœªå¤„äºdragæ¨¡å¼ï¼Œä½†æ˜¯yDiff &gt; mTouchSlopï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è®¤ä¸ºdragæ¨¡å¼è¢«è§¦å‘äº†ã€‚å®è§‚æ¥è¯´å°±æ˜¯ç”¨æˆ·æ‹–åŠ¨äº†ä¸€æ®µè·ç¦»ã€‚TOUCH_SLOPæ˜¯åœ¨
ViewConfigrationç±»é‡Œå®šä¹‰ï¼Œæ˜¯16pxã€‚dragæ¨¡å¼è§¦å‘åï¼Œæˆ‘ä»¬ä¹Ÿè¦å¼€å§‹æ‹¦æˆªactionMoveäº‹ä»¶ã€‚æ¥ä¸‹æ¥çœ‹actionDownäº‹ä»¶</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">inChild</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">(),</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">y</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="cm">/*
                 * Remember location of down touch.
                 * ACTION_DOWN always refers to pointer index 0.
                 */</span>
                <span class="n">mLastMotionY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
                <span class="n">mActivePointerId</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getPointerId</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

                <span class="cm">/*
                * If being flinged and user touches the screen, initiate drag;
                * otherwise don't.  mScroller.isFinished should be false when
                * being flinged.
                */</span>
                <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="o">!</span><span class="n">mScroller</span><span class="o">.</span><span class="na">isFinished</span><span class="o">();</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span></code></pre></figure>

<p>ç‚¹å‡»ä½ç½®ä¸åœ¨å­æ§ä»¶é‡Œé¢ï¼ŒmIsBeingDragged = falseï¼Œä¸æ‹¦æˆªè¯¥äº‹ä»¶ã€‚å¦‚æœå½“å‰å¤„äºflingæ¨¡å¼ï¼Œé‚£ä¹ˆmIsBeingDragged = !mScroller.isFinished()
è¿”å›ä¸ºtrue,å³æ‹¦æˆªè¯¥äº‹ä»¶ï¼Œæƒ³å¿…æ˜¯ä¸ºflingæ¨¡å¼ä¸‹è§¦æ‘¸åœæ­¢çš„åŠŸèƒ½åšé“ºå«ï¼Œåç»­çš„ä»£ç é‡Œæˆ‘ä»¬ä¼šéªŒè¯è¿™ä¸ªçŒœæƒ³ã€‚æ¥ä¸‹æ¥çœ‹actionUpäº‹ä»¶</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>
                <span class="cm">/* Release the drag */</span>
                <span class="n">mIsBeingDragged</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="n">mActivePointerId</span> <span class="o">=</span> <span class="no">INVALID_POINTER</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">springBack</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">getScrollRange</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="n">invalidate</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span></code></pre></figure>

<p>å¯¹äºactionUpäº‹ä»¶ï¼Œç›´æ¥mIsBeingDragged = falseï¼Œå³è„±ç¦»dragæ¨¡å¼ã€‚ä¹Ÿä¸è¿›è¡Œæ‹¦æˆªã€‚mScroller.springBackæ˜¯é’ˆå¯¹æ»‘åŠ¨å›å¼¹çš„æƒ…å½¢ï¼Œåœ¨æ²¡æœ‰å›å¼¹çš„
æƒ…å†µä¸‹æ˜¯è¿”å›falseçš„ï¼Œæ—¢ä¸ä¼šæœ‰é‡ç»˜æ“ä½œã€‚å¸¸è§„æƒ…å†µä¸‹ï¼ŒactionUpäº‹ä»¶å°±æ˜¯è„±ç¦»dragæ¨¡å¼ï¼Œå¹¶æ¸…ç©ºæ¿€æ´»çš„è§¦æ‘¸ç‚¹mActivePointerIdã€‚</p>

<p>åˆ†æäº†æ‹¦æˆªæ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±å¾—çœ‹onTouchEventæ–¹æ³•äº†ï¼Œåœ¨æˆ‘çš„â€œä¹Ÿè°ˆAndroidäº‹ä»¶åˆ†å‘â€æ–‡ç« ä¸­å·²ç»è¯¦ç»†çš„æè¿°äº†äº‹ä»¶åˆ†å‘çš„åŸç†ã€‚</p>

<p>å¯¹äºonTouchEventæ–¹æ³•æˆ‘ä»¬ä¸»è¦åˆ†æactionMoveäº‹ä»¶ï¼Œå…¶ä»–çš„äº‹ä»¶æºç è¯»è€…æœ‰ç©ºå¯ä»¥è‡ªå·±é˜…è¯»ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">case</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">:</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mIsBeingDragged</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Scroll to follow the motion event</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">activePointerIndex</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">findPointerIndex</span><span class="o">(</span><span class="n">mActivePointerId</span><span class="o">);</span> <span class="c1">// æ‰¾åˆ°æœ‰æ•ˆæ¥è§¦ç‚¹</span>
        <span class="kd">final</span> <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">(</span><span class="n">activePointerIndex</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">deltaY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">mLastMotionY</span> <span class="o">-</span> <span class="n">y</span><span class="o">);</span>
        <span class="n">mLastMotionY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldX</span> <span class="o">=</span> <span class="n">mScrollX</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldY</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="n">getScrollRange</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">overScrollBy</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">deltaY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">range</span><span class="o">,</span>
                <span class="mi">0</span><span class="o">,</span> <span class="n">mOverscrollDistance</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// Break our velocity if we hit a scroll barrier.</span>
            <span class="n">mVelocityTracker</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">onScrollChanged</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">oldY</span><span class="o">);</span>
    <span class="o">....</span></code></pre></figure>

<p>å…³é”®æ–¹æ³•æ˜¯overScrollBy(),overScrollByæ˜¯Viewç±»çš„æ–¹æ³•ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">overScrollBy</span><span class="o">(</span><span class="kt">int</span> <span class="n">deltaX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">deltaY</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">scrollX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scrollY</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">scrollRangeX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scrollRangeY</span><span class="o">,</span>
            <span class="kt">int</span> <span class="n">maxOverScrollX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxOverScrollY</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">isTouchEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">overScrollMode</span> <span class="o">=</span> <span class="n">mOverScrollMode</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">canScrollHorizontal</span> <span class="o">=</span>
                <span class="n">computeHorizontalScrollRange</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">computeHorizontalScrollExtent</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">canScrollVertical</span> <span class="o">=</span>
                <span class="n">computeVerticalScrollRange</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">computeVerticalScrollExtent</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">overScrollHorizontal</span> <span class="o">=</span> <span class="n">overScrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_ALWAYS</span> <span class="o">||</span>
                <span class="o">(</span><span class="n">overScrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_IF_CONTENT_SCROLLS</span> <span class="o">&amp;&amp;</span> <span class="n">canScrollHorizontal</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">overScrollVertical</span> <span class="o">=</span> <span class="n">overScrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_ALWAYS</span> <span class="o">||</span>
                <span class="o">(</span><span class="n">overScrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_IF_CONTENT_SCROLLS</span> <span class="o">&amp;&amp;</span> <span class="n">canScrollVertical</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">newScrollX</span> <span class="o">=</span> <span class="n">scrollX</span> <span class="o">+</span> <span class="n">deltaX</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">overScrollHorizontal</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">maxOverScrollX</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">newScrollY</span> <span class="o">=</span> <span class="n">scrollY</span> <span class="o">+</span> <span class="n">deltaY</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">overScrollVertical</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">maxOverScrollY</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Clamp values if at the limits and record</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="o">-</span><span class="n">maxOverScrollX</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">maxOverScrollX</span> <span class="o">+</span> <span class="n">scrollRangeX</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">top</span> <span class="o">=</span> <span class="o">-</span><span class="n">maxOverScrollY</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">maxOverScrollY</span> <span class="o">+</span> <span class="n">scrollRangeY</span><span class="o">;</span>

        <span class="kt">boolean</span> <span class="n">clampedX</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">newScrollX</span> <span class="o">&gt;</span> <span class="n">right</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newScrollX</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
            <span class="n">clampedX</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">newScrollX</span> <span class="o">&lt;</span> <span class="n">left</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newScrollX</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
            <span class="n">clampedX</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">boolean</span> <span class="n">clampedY</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">newScrollY</span> <span class="o">&gt;</span> <span class="n">bottom</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newScrollY</span> <span class="o">=</span> <span class="n">bottom</span><span class="o">;</span>
            <span class="n">clampedY</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">newScrollY</span> <span class="o">&lt;</span> <span class="n">top</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newScrollY</span> <span class="o">=</span> <span class="n">top</span><span class="o">;</span>
            <span class="n">clampedY</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">onOverScrolled</span><span class="o">(</span><span class="n">newScrollX</span><span class="o">,</span> <span class="n">newScrollY</span><span class="o">,</span> <span class="n">clampedX</span><span class="o">,</span> <span class="n">clampedY</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">clampedX</span> <span class="o">||</span> <span class="n">clampedY</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>overScrollByå…¶å®å°±æ˜¯æ£€æŸ¥ä½ æœ‰æ²¡æœ‰ä¸€æ»‘åˆ°åº•ï¼ˆè¾¹ç•Œï¼‰ã€‚ä½†æ˜¯å…¶ä¸­å…³é”®æ˜¯ä»–è°ƒç”¨äº†onOverScrolledã€‚
viewçš„onOverScrolledæ˜¯ä¸€ä¸ªç©ºçš„å®ç°ï¼Œé‚£æˆ‘ä»¬å»çœ‹ä¸‹ScrollViewæ§ä»¶æ˜¯å¦‚ä½•å®ç°çš„</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onOverScrolled</span><span class="o">(</span><span class="kt">int</span> <span class="n">scrollX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scrollY</span><span class="o">,</span>
          <span class="kt">boolean</span> <span class="n">clampedX</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">clampedY</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Treat animating scrolls differently; see #computeScroll() for why.</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">mScroller</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">mScrollX</span> <span class="o">=</span> <span class="n">scrollX</span><span class="o">;</span>
          <span class="n">mScrollY</span> <span class="o">=</span> <span class="n">scrollY</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">clampedY</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">mScroller</span><span class="o">.</span><span class="na">springBack</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">getScrollRange</span><span class="o">());</span>
          <span class="o">}</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">scrollTo</span><span class="o">(</span><span class="n">scrollX</span><span class="o">,</span> <span class="n">scrollY</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">awakenScrollBars</span><span class="o">();</span>
  <span class="o">}</span></code></pre></figure>

<p>mScroller.isFinished()å…¶å®æ ‡è®°çš„å°±æ˜¯flingæ¨¡å¼ï¼Œåç»­æˆ‘ä»¬å¯ä»¥éªŒè¯è¿™ä¸ªè§‚ç‚¹ã€‚æ˜¾ç„¶æˆ‘ä»¬åœ¨å¤„ç†actionMoveäº‹ä»¶ï¼Œæ˜¯å¤„äºdragæ¨¡å¼ï¼Œè€Œé
flingæ¨¡å¼çš„ã€‚æ‰€ä»¥ï¼Œå…¶å®æ˜¯èµ°çš„super.scrollTo(scrollX, scrollY)åˆ†æ”¯äº†ã€‚çœ‹ä¸‹view.scrollToæ–¹æ³•</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">scrollTo</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mScrollX</span> <span class="o">!=</span> <span class="n">x</span> <span class="o">||</span> <span class="n">mScrollY</span> <span class="o">!=</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">oldX</span> <span class="o">=</span> <span class="n">mScrollX</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">oldY</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
            <span class="n">mScrollX</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
            <span class="n">mScrollY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
            <span class="n">onScrollChanged</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">oldY</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">awakenScrollBars</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">invalidate</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>ä»£ç éå¸¸çš„ç®€å•ï¼Œä½†æ˜¯å±äºæ ¸å¿ƒä»£ç ã€‚ä½œç”¨å°±æ˜¯æ›´æ–°mScrollY,ç„¶åé€šè¿‡invalidate()è¿›è¡Œé‡ç»˜ã€‚è€Œæ‰€è°“viewçš„æ»šåŠ¨ï¼Œå®ƒçš„åŸç†å°±æ˜¯æ›´æ–°mScrollYç„¶å
åˆ·æ–°é¡µé¢ã€‚</p>

<p>ç”±äºactionMoveäº‹ä»¶éƒ½æ˜¯è¿ç»­çš„ï¼Œè€Œä¸”æ¯æ¬¡yè½´çš„å˜åŒ–é‡ä¸å¤§ï¼Œæ‰€ä»¥åœ¨dragæ¨¡å¼ä¸‹,ä¸ä¼šçªç„¶ä¸€ä¸‹æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®ã€‚ä½†æ˜¯scrollToä¹Ÿæ˜¯Viewç±»çš„ä¸€ä¸ª
å…¬å¼€api,å½“ç›®æ ‡ä½ç½®å’Œå½“å‰ä½ç½®å·®å€¼è¾ƒå¤§æ—¶ï¼Œä¼šçªç„¶æ»šåŠ¨è¿‡å»ã€‚å¾€å¾€æˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªç¼“ç¼“æ»šåŠ¨è¿‡å»çš„åŠ¨ç”»ï¼Œè¿™ä¸ªæ—¶å€™ScrollViewçš„ç‰¹æ®ŠApi smoothScrollTo
å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p>

<p>smoothScrollToçš„æ ¸å¿ƒç±»å°±æ˜¯Scrollerç±»äº†ï¼Œä¹Ÿæ˜¯æ¥ä¸‹æ¥é‡ç‚¹è¦åˆ†æçš„ä¸€ä¸ªç±»ã€‚<br />
å…ˆçœ‹çœ‹ScrollViewçš„smoothScrollToæ–¹æ³•</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">smoothScrollBy</span><span class="o">(</span><span class="kt">int</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">getChildCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Nothing to do.</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="nc">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">mLastScroll</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="no">ANIMATED_SCROLL_GAP</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">getHeight</span><span class="o">()</span> <span class="o">-</span> <span class="n">mPaddingBottom</span> <span class="o">-</span> <span class="n">mPaddingTop</span><span class="o">;</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxY</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">height</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">scrollY</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">scrollY</span> <span class="o">+</span> <span class="n">dy</span><span class="o">,</span> <span class="n">maxY</span><span class="o">))</span> <span class="o">-</span> <span class="n">scrollY</span><span class="o">;</span>

        <span class="n">mScroller</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">scrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>
        <span class="n">invalidate</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">mScroller</span><span class="o">.</span><span class="na">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">mScroller</span><span class="o">.</span><span class="na">abortAnimation</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">scrollBy</span><span class="o">(</span><span class="n">dx</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">mLastScroll</span> <span class="o">=</span> <span class="nc">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>æ ¸å¿ƒæ–¹æ³•åªæœ‰ä¸¤å¥</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java">  <span class="n">mScroller</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">scrollY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>
  <span class="n">invalidate</span><span class="o">();</span></code></pre></figure>

<p>å…ˆæ¥çœ‹mScroller.startScrollåšäº†ä»€ä¹ˆ</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">startScroll</span><span class="o">(</span><span class="kt">int</span> <span class="n">startX</span><span class="o">,</span> <span class="kt">int</span> <span class="n">startY</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mMode</span> <span class="o">=</span> <span class="no">SCROLL_MODE</span><span class="o">;</span>
    <span class="n">mScrollerX</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">startX</span><span class="o">,</span> <span class="n">dx</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
    <span class="n">mScrollerY</span><span class="o">.</span><span class="na">startScroll</span><span class="o">(</span><span class="n">startY</span><span class="o">,</span> <span class="n">dy</span><span class="o">,</span> <span class="n">duration</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// OverScrollerå†…éƒ¨ç±»MagneticOverScrollerçš„æ–¹æ³•</span>
<span class="kt">void</span> <span class="nf">startScroll</span><span class="o">(</span><span class="kt">int</span> <span class="n">start</span><span class="o">,</span> <span class="kt">int</span> <span class="n">distance</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mFinished</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="n">mStart</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
    <span class="n">mFinal</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">distance</span><span class="o">;</span>

    <span class="n">mStartTime</span> <span class="o">=</span> <span class="nc">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
    <span class="n">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>

    <span class="c1">// Unused</span>
    <span class="n">mDeceleration</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="o">;</span>
    <span class="n">mVelocity</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>è¿™é‡Œé¢å¥½åƒæ²¡å¹²ä»€ä¹ˆäº‹æƒ…ï¼Œæ— éè®°å½•äº†ä¸‹å¼€å§‹çš„ä½ç½®ï¼Œç»“æŸçš„ä½ç½®ï¼ŒåŠ¨ç”»å¼€å§‹çš„äº‹ä»¶ï¼ŒåŠ¨ç”»æŒç»­çš„æ—¶é—´ç­‰å±æ€§ã€‚ <br />
é‚£ä¹ˆå®ç°åŠ¨ç”»æ»šåŠ¨çš„ä»£ç åˆ°åº•åœ¨å“ªå‘¢ã€‚å…¶å®è¿™é‡Œéœ€è¦ä½ å¯¹Viewç±»çš„ç»˜åˆ¶æºç æœ‰ä¸€å®šçš„äº†è§£ï¼Œéœ€è¦æœ‰ä¸€ä¸ªå¯¹æºç çš„ç†Ÿæ‚‰åº¦ï¼Œæˆ‘å°±ç›´æ¥ä¸Šæºç å§ <br />
ViewGroupçš„drawChildæ–¹æ³•é‡Œ</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"> <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">drawChild</span><span class="o">(</span><span class="nc">Canvas</span> <span class="n">canvas</span><span class="o">,</span> <span class="nc">View</span> <span class="n">child</span><span class="o">,</span> <span class="kt">long</span> <span class="n">drawingTime</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">....</span>
  <span class="c1">// Sets the flag as early as possible to allow draw() implementations</span>
      <span class="c1">// to call invalidate() successfully when doing animations</span>
      <span class="n">child</span><span class="o">.</span><span class="na">mPrivateFlags</span> <span class="o">|=</span> <span class="no">DRAWN</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">concatMatrix</span> <span class="o">&amp;&amp;</span> <span class="n">canvas</span><span class="o">.</span><span class="na">quickReject</span><span class="o">(</span><span class="n">cl</span><span class="o">,</span> <span class="n">ct</span><span class="o">,</span> <span class="n">cr</span><span class="o">,</span> <span class="n">cb</span><span class="o">,</span> <span class="nc">Canvas</span><span class="o">.</span><span class="na">EdgeType</span><span class="o">.</span><span class="na">BW</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
              <span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">mPrivateFlags</span> <span class="o">&amp;</span> <span class="no">DRAW_ANIMATION</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">more</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="n">child</span><span class="o">.</span><span class="na">computeScroll</span><span class="o">();</span>

      <span class="kd">final</span> <span class="kt">int</span> <span class="n">sx</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">mScrollX</span><span class="o">;</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">mScrollY</span><span class="o">;</span>
  <span class="o">....</span>
<span class="o">}</span></code></pre></figure>

<p>æ ¸å¿ƒå°±æ˜¯child.computeScroll()è¿™ä¸ªæ–¹æ³•äº†ã€‚åç»­å¯ä»¥å¯¹viewçš„ç»˜åˆ¶ä½“ç³»åšä¸€ç¯‡æºç åˆ†æï¼Œä¸»è¦æ˜¯æ¶‰åŠçš„å†…å®¹å¤ªå¤šäº†ã€‚<br />
ä¹Ÿå°±æ˜¯æ¯æ¬¡é‡ç»˜æ—¶ï¼ŒviewGroupåœ¨ç»˜åˆ¶childæ—¶éƒ½ä¼šè®¡ç®—childçš„scrollå€¼ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±ç®€å•äº†ï¼Œæˆ‘ä»¬çœ‹ä¸‹ScrollViewæ˜¯å¦‚ä½•å®ç°computeScrollæ–¹æ³•å§</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">computeScroll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mScroller</span><span class="o">.</span><span class="na">computeScrollOffset</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// This is called at drawing time by ViewGroup.  We don't want to</span>
            <span class="c1">// re-show the scrollbars at this point, which scrollTo will do,</span>
            <span class="c1">// so we replicate most of scrollTo here.</span>
            <span class="c1">//</span>
            <span class="c1">//         It's a little odd to call onScrollChanged from inside the drawing.</span>
            <span class="c1">//</span>
            <span class="c1">//         It is, except when you remember that computeScroll() is used to</span>
            <span class="c1">//         animate scrolling. So unless we want to defer the onScrollChanged()</span>
            <span class="c1">//         until the end of the animated scrolling, we don't really have a</span>
            <span class="c1">//         choice here.</span>
            <span class="c1">//</span>
            <span class="c1">//         I agree.  The alternative, which I think would be worse, is to post</span>
            <span class="c1">//         something and tell the subclasses later.  This is bad because there</span>
            <span class="c1">//         will be a window where mScrollX/Y is different from what the app</span>
            <span class="c1">//         thinks it is.</span>
            <span class="c1">//</span>
            <span class="kt">int</span> <span class="n">oldX</span> <span class="o">=</span> <span class="n">mScrollX</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">oldY</span> <span class="o">=</span> <span class="n">mScrollY</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrX</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrY</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">oldX</span> <span class="o">!=</span> <span class="n">x</span> <span class="o">||</span> <span class="n">oldY</span> <span class="o">!=</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">overScrollBy</span><span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">oldY</span><span class="o">,</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">oldY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">getScrollRange</span><span class="o">(),</span>
                        <span class="mi">0</span><span class="o">,</span> <span class="n">mOverflingDistance</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">onScrollChanged</span><span class="o">(</span><span class="n">mScrollX</span><span class="o">,</span> <span class="n">mScrollY</span><span class="o">,</span> <span class="n">oldX</span><span class="o">,</span> <span class="n">oldY</span><span class="o">);</span>

                <span class="kd">final</span> <span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="n">getScrollRange</span><span class="o">();</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">overscrollMode</span> <span class="o">=</span> <span class="n">getOverScrollMode</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">overscrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_ALWAYS</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">overscrollMode</span> <span class="o">==</span> <span class="no">OVER_SCROLL_IF_CONTENT_SCROLLS</span> <span class="o">&amp;&amp;</span> <span class="n">range</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">oldY</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mEdgeGlowTop</span><span class="o">.</span><span class="na">onAbsorb</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrVelocity</span><span class="o">());</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">range</span> <span class="o">&amp;&amp;</span> <span class="n">oldY</span> <span class="o">&lt;=</span> <span class="n">range</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mEdgeGlowBottom</span><span class="o">.</span><span class="na">onAbsorb</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">mScroller</span><span class="o">.</span><span class="na">getCurrVelocity</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">awakenScrollBars</span><span class="o">();</span>

            <span class="c1">// Keep on drawing until the animation has finished.</span>
            <span class="n">postInvalidate</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>æ ¸å¿ƒä»£ç ä¹Ÿä¸è¿‡ä¸¤å¥ï¼ŒoverScrollByå’ŒpostInvalidate()ã€‚æ— éœ€åˆ†æäº†ã€‚é‡ç‚¹å…³æ³¨ä¸‹mScroller.computeScrollOffset()</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">computeScrollOffset</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isFinished</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">switch</span> <span class="o">(</span><span class="n">mMode</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nl">SCROLL_MODE:</span>
                <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="nc">AnimationUtils</span><span class="o">.</span><span class="na">currentAnimationTimeMillis</span><span class="o">();</span>
                <span class="c1">// Any scroller can be used for time, since they were started</span>
                <span class="c1">// together in scroll mode. We use X here.</span>
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">elapsedTime</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">mScrollerX</span><span class="o">.</span><span class="na">mStartTime</span><span class="o">;</span>

                <span class="kd">final</span> <span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">mScrollerX</span><span class="o">.</span><span class="na">mDuration</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">elapsedTime</span> <span class="o">&lt;</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">float</span> <span class="n">q</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="o">(</span><span class="n">elapsedTime</span><span class="o">)</span> <span class="o">/</span> <span class="n">duration</span><span class="o">;</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">mInterpolator</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="nc">Scroller</span><span class="o">.</span><span class="na">viscousFluid</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                    <span class="k">else</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="n">mInterpolator</span><span class="o">.</span><span class="na">getInterpolation</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>

                    <span class="n">mScrollerX</span><span class="o">.</span><span class="na">updateScroll</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                    <span class="n">mScrollerY</span><span class="o">.</span><span class="na">updateScroll</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">abortAnimation</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>

            <span class="k">case</span> <span class="nl">FLING_MODE:</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerX</span><span class="o">.</span><span class="na">mFinished</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerX</span><span class="o">.</span><span class="na">update</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerX</span><span class="o">.</span><span class="na">continueWhenFinished</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">mScrollerX</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">mFinished</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">update</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(!</span><span class="n">mScrollerY</span><span class="o">.</span><span class="na">continueWhenFinished</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">mScrollerY</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>mModeåªæœ‰åœ¨ç”¨åˆ°mScroolerç±»çš„æ—¶å€™æ‰ä¼šæœ‰å€¼ï¼Œæ‰€ä»¥åƒå‰é¢æåˆ°çš„onTouchEventé‡Œé¢ï¼ŒmModeæ˜¯æ²¡æœ‰å€¼çš„ï¼ŒcomputeScrollOffset()æ˜¯ä¼šç›´æ¥è¿”å›trueçš„ã€‚ <br />
ä¸ºä»€ä¹ˆmModeæœ‰å€¼å¾ˆé‡è¦å‘¢ï¼Œå› ä¸ºå°±æ˜¯mScrollerY.updateScroll(q)å®ç°äº†åŠ¨æ€æ”¹å˜æ»‘åŠ¨çš„ç›®æ ‡å€¼ï¼Œå³æˆ‘ä»¬çš„smoothScrollçš„åŠ¨æ•ˆã€‚</p>

<p>é‚£ä¹ˆåˆ°ç°åœ¨å‘¢ï¼Œå¯¹äºScrollViewå’ŒScrollerç±»å¦‚ä½•å®ç°æ»‘åŠ¨ï¼Œæ— è®ºæ˜¯èµ°è§¦æ‘¸äº‹ä»¶ï¼Œè¿˜æ˜¯è°ƒç”¨api smoothScrollToã€‚æˆ‘ä»¬å·²ç»è®²çš„éå¸¸æ¸…æ™°äº†ã€‚è¿™ç¯‡åšå®¢å°±
åˆ°æ­¤ä¸ºæ­¢äº†ã€‚</p>
:ET