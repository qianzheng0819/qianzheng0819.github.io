I"¬T<h2 id="clh-lock">CLH lock</h2>
<p>CLHæ˜¯ä¸€ä¸ªåŸºäºé“¾è¡¨ï¼ˆé˜Ÿåˆ—ï¼‰éçº¿ç¨‹é¥¥é¥¿çš„è‡ªæ—‹ï¼ˆå…¬å¹³ï¼‰é”ï¼Œç”±äºæ˜¯ Craigã€Landin å’Œ Hagerstenä¸‰äººçš„å‘æ˜ï¼Œå› æ­¤å‘½åä¸ºCLHé”ã€‚æ¯ä¸€ä¸ªç­‰å¾…é”çš„çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹ï¼Œä¸æ–­è‡ªæ—‹åˆ¤æ–­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”å°±ç»“æŸè‡ªæ—‹</p>

<p>ç‰¹ç‚¹ï¼šè¯¥ç®—æ³•åªä¸€ä¸ªCASæ“ä½œï¼Œå³å¯è®©æ‰€æœ‰ç­‰å¾…è·å–é”çš„çº¿ç¨‹æ„å»ºæœ‰åºå…¨å±€é˜Ÿåˆ—ã€‚</p>

<h3 id="åŸç†">åŸç†</h3>
<hr />
<p>1ã€é¦–å…ˆæœ‰ä¸€ä¸ªå°¾èŠ‚ç‚¹æŒ‡é’ˆï¼Œé€šè¿‡è¿™ä¸ªå°¾ç»“ç‚¹æŒ‡é’ˆæ¥æ„å»ºç­‰å¾…çº¿ç¨‹çš„é€»è¾‘é˜Ÿåˆ—ï¼ˆæ‰€æœ‰æ¯ä¸ªçº¿ç¨‹è¿˜åº”è¯¥ä¿å­˜å‰é¢Nodeçš„çŠ¶æ€ï¼Œé“¾è¡¨å½¢å¼ï¼‰ï¼Œå› æ­¤èƒ½ç¡®ä¿çº¿ç¨‹çº¿ç¨‹å…ˆåˆ°å…ˆæœåŠ¡çš„å…¬å¹³æ€§ï¼Œå› æ­¤å°¾  æŒ‡é’ˆå¯ä»¥è¯´æ˜¯æ„å»ºé€»è¾‘é˜Ÿåˆ—çš„æ¡¥æ¢ï¼›æ­¤å¤–è¿™ä¸ªå°¾èŠ‚ç‚¹æŒ‡é’ˆæ˜¯åŸå­å¼•ç”¨ç±»å‹ï¼Œé¿å…äº†å¤šçº¿ç¨‹å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼›</p>

<p>2ã€æ¯ä¸ªç­‰å¾…é”çš„çº¿ç¨‹åœ¨è‡ªå·±çš„å‰é©±èŠ‚ç‚¹æŸä¸ªå˜é‡ä¸Šè‡ªæ—‹ç­‰å¾…ï¼Œç­‰å¾…å‰é©±è§£é”ä¹‹åå³å¯å»è·å–é”ã€‚</p>

<h3 id="å›¾è§£">å›¾è§£</h3>
<hr />
<div align="center">
<img src="/assets/images/2022-pic/p1.svg" />
</div>

<div align="center">
<img src="/assets/images/2022-pic/p2.svg" />
</div>

<h3 id="åŸç†å®ç°">åŸç†å®ç°</h3>
<hr />
<p>1ã€å› ä¸ºæ˜¯åŸºäºé“¾è¡¨ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹é™¤äº†ä¿å­˜å½“å‰çº¿ç¨‹çš„nodeæƒ…å†µè¿˜éœ€ä¿å­˜å‰ä¸€ä¸ªèŠ‚ç‚¹çš„nodeæƒ…å†µã€‚</p>

<p>(1)ã€ä¿å­˜å½“å‰çº¿ç¨‹çš„nodeæ˜¯ä¸ºäº†è§£é”çš„æ—¶å€™å¯ä»¥ç›´æ¥è·å–å½“å‰èŠ‚ç‚¹çš„nodeï¼Œé‡Šæ”¾é”</p>

<p>(2)ã€ä¿å­˜å‰é©±èŠ‚ç‚¹çš„nodeæ˜¯ä¸ºäº†æ„å»ºæœ‰åºåˆ—è¡¨ã€‚</p>

<p>2ã€å› ä¸ºå…¶å®ƒçº¿ç¨‹å“ªä¸ªå…ˆå¼€å§‹ä¸ç¡®å®šä¸”æ–¹ä¾¿å½“å‰çº¿ç¨‹å®‰å…¨çš„è·å–ä¸Šä¸€ä¸ªçº¿ç¨‹çš„nodeä½œä¸ºå‰é©±èŠ‚ç‚¹ï¼Œæ‰€ä»¥åº”è¯¥æœ‰ä¸ªå˜é‡ï¼ˆç§°ä¸ºtailå˜é‡ï¼‰ä¿å­˜æ¯ä¸€ä¸ªæŸæ—¶åˆ»çš„çº¿ç¨‹nodeæ–¹ä¾¿ä¸‹ä¸€æ—¶åˆ»è·å–è¯¥nodeä½œä¸ºå‰é©±èŠ‚ç‚¹</p>

<p>(1)ã€æ‰€ä»¥è¿˜åº”è¯¥æœ‰ä¸ªtailå˜é‡ï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨çš„æ—¶å€™è¦æ±‚å®‰å…¨çš„è·å–å¹¶æ›¿æ¢æ‰€ä»¥è¿™é‡Œä½¿ç”¨åŸå­å¼•ç”¨ç±»å‹ã€‚</p>

<h3 id="ä»£ç å®ç°">ä»£ç å®ç°</h3>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Executor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicReference</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CLHLockExample</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">QNode</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span> <span class="c1">// æ‰“å°ä½¿ç”¨ï¼Œç¬¬å‡ ä¸ªåˆ›å»ºçš„QNode</span>
        <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">locked</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">QNode</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"(QNode_"</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s">"_locked:"</span> <span class="o">+</span> <span class="n">locked</span> <span class="o">+</span> <span class="s">")"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">interface</span> <span class="nc">Lock</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">lock</span><span class="o">();</span>

        <span class="kt">void</span> <span class="nf">unlock</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CLHLock</span> <span class="kd">implements</span> <span class="nc">Lock</span> <span class="o">{</span>
        <span class="cm">/**
         * å°¾å·´ï¼Œæ‰€æœ‰çº¿ç¨‹å…±ç”¨çš„ä¸€ä¸ªå˜é‡ã€‚æ¯ä¸ªçº¿ç¨‹è¿›æ¥åï¼ŒæŠŠè‡ªå·±è®¾ç½®ä¸ºtailï¼Œæ–¹ä¾¿ä¸‹ä¸€æ—¶åˆ»çº¿ç¨‹è·å–å‰é©±èŠ‚ç‚¹
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">QNode</span><span class="o">&gt;</span> <span class="n">tail</span><span class="o">;</span>
        <span class="cm">/**
         * ç”¨äºçº¿ç¨‹ä¿å­˜å‰é©±èŠ‚ç‚¹ï¼Œæ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰ä¸€ä¸ªã€‚
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">QNode</span><span class="o">&gt;</span> <span class="n">myPred</span><span class="o">;</span>
        <span class="cm">/**
         * ç”¨æˆ·çº¿ç¨‹ä¿å­˜å½“å‰èŠ‚ç‚¹ï¼Œæ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰ä¸€ä¸ªã€‚
         */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">QNode</span><span class="o">&gt;</span> <span class="n">myNode</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CLHLock</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// ç»™ä¸€ä¸ªåˆå§‹å€¼ï¼Œæ­¤æ—¶æ—¢æ˜¯å°¾å·´ä¹Ÿæ˜¯å¤´ï¼Œé»˜è®¤falseï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªæŠ¢å çš„çº¿ç¨‹å°†ç›´æ¥æ‰§è¡Œï¼Œå› ä¸ºå‰é©±æ˜¯false</span>
            <span class="k">this</span><span class="o">.</span><span class="na">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">QNode</span><span class="o">());</span>
            <span class="c1">// getæ—¶å½“å‰çº¿ç¨‹æ²¡æœ‰å€¼åˆ™è¿”å›ä¸€ä¸ªæ–°çš„QNode</span>
            <span class="k">this</span><span class="o">.</span><span class="na">myNode</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(</span><span class="nl">QNode:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
            <span class="c1">// åˆå§‹åŒ–å½“å‰èŠ‚ç‚¹ä¿å­˜å‰é©±èŠ‚ç‚¹çš„ThreadLocal</span>
            <span class="k">this</span><span class="o">.</span><span class="na">myPred</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">peekNodeInfo</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="s">". "</span> <span class="o">+</span>
                    <span class="s">"myNode"</span> <span class="o">+</span> <span class="n">myNode</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span>
                    <span class="s">"myPred"</span> <span class="o">+</span> <span class="n">myPred</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>

        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// è·å–å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span>
            <span class="nc">QNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">myNode</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="c1">// å°†è‡ªå·±çš„çŠ¶æ€è®¾ç½®ä¸ºtrueè¡¨ç¤ºè·å–é”ã€‚</span>
            <span class="n">node</span><span class="o">.</span><span class="na">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="c1">// å°†è‡ªå·±æ”¾åœ¨é˜Ÿåˆ—çš„å°¾å·´ï¼Œå¹¶ä¸”è¿”å›ä»¥å‰çš„èŠ‚ç‚¹ä½œä¸ºå‰é©±èŠ‚ç‚¹ã€‚</span>
            <span class="nc">QNode</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">tail</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="c1">// è®¾ç½®å‰é©±èŠ‚ç‚¹</span>
            <span class="n">myPred</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pred</span><span class="o">);</span>
            <span class="c1">// åœ¨ç­‰å¾…å‰é©±èŠ‚ç‚¹çš„lockedåŸŸå˜ä¸ºfalseï¼Œè¿™æ˜¯ä¸€ä¸ªè‡ªæ—‹ç­‰å¾…çš„è¿‡ç¨‹</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">pred</span><span class="o">.</span><span class="na">locked</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
            <span class="n">peekNodeInfo</span><span class="o">(</span><span class="s">"acquire lock success"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// unlock. è·å–è‡ªå·±çš„nodeã€‚ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç”¨ThreadLocalä¿å­˜å½“å‰çº¿ç¨‹çš„åŸå› ï¼‰æŠŠè‡ªå·±çš„lockedè®¾ç½®ä¸ºfalseã€‚</span>
            <span class="nc">QNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">myNode</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="n">node</span><span class="o">.</span><span class="na">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="c1">// é˜²æ­¢æ­»é”ã€‚å¦‚æœæ²¡æœ‰ä¸‹ä¸€å¥ï¼Œè‹¥å½“å‰çº¿ç¨‹unlockåè¿…é€Ÿç«äº‰åˆ°é”ï¼Œç”±äºå½“å‰çº¿ç¨‹è¿˜ä¿å­˜ç€è‡ªå·±çš„node,æ‰€ä»¥`QNode node = this.myNodeThreadLocal.get();`</span>
            <span class="c1">// è·å–çš„ä¾æ—§æ˜¯è¯¥çº¿ç¨‹çš„node(æ­¤æ—¶è¯¥nodeè¿˜è¢«é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼•ç”¨)ï¼Œæ‰§è¡ŒlockåæŠŠè‡ªå·±çš„locked = trueç„¶åæŠŠè‡ªå·±åˆåŠ åœ¨å°¾éƒ¨ï¼Œ</span>
            <span class="c1">// ç„¶è€Œé“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è¿˜åœ¨ç­‰è¯¥çº¿ç¨‹çš„locked = falseè€Œå½“å‰èŠ‚ç‚¹è¿˜åœ¨ç­‰è‡ªå·±ä¹‹å‰çš„èŠ‚ç‚¹locked = falseï¼Œ1-&gt;3-&gt;2 1åœ¨ç­‰2æ‰§è¡Œ,2åœ¨ç­‰3æ‰§è¡Œ,3åˆå¿…é¡»è®©1å…ˆæ‰§è¡Œå®Œã€‚</span>
            <span class="c1">// æ‰€ä»¥é˜²æ­¢ä¸Šè¿°äº‹æƒ…çš„å‘ç”Ÿï¼Œé‡Šæ”¾é”æ—¶ä¸èƒ½å…è®¸å½“å‰çº¿ç¨‹è¿˜ä¿å­˜è‡ªå·±çš„nodeï¼Œé˜²æ­¢è¯¥çº¿ç¨‹å†æ¬¡æŠ¢å çº¿ç¨‹å‘ç”Ÿæ­»é”ã€‚</span>

            <span class="c1">// æ­¤æ—¶å¤„ç†æ–¹å¼æœ‰ä¸‰ç§ï¼šï¼ˆé—®é¢˜å‡ºåœ¨è¯¥çº¿ç¨‹åˆç«äº‰åˆ°é”çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯¥çº¿ç¨‹è¿ç»­ä¸¤æ¬¡æŠ¢åˆ°é”ï¼‰</span>
            <span class="c1">// (1)ã€this.myNodeThreadLocal.set(null);</span>
            <span class="c1">// (2)ã€this.myNodeThreadLocal.set(new CLHNode());</span>
            <span class="c1">// (3)ã€this.myNodeThreadLocal.set(predNodeThreadLocal.get());</span>
            <span class="c1">// ä¸‰ç§æ¯”è¾ƒï¼Œå¯¹äº1ã€2ä¸­QNode node = this.myNodeThreadLocal.get();æœ¬çº¿ç¨‹éƒ½ä¼šè·å–æ–°çš„node,ç„¶è€Œåœ¨ç¬¬äºŒæ¬¡æŠ¢åˆ°é”lock()æ—¶</span>
            <span class="c1">// QNode pred = tail.getAndSet(node);this.predNodeThreadLocal.set(pred);ä¼šè®¾ç½®æ–°çš„å‰é©±nodeå¯¼è‡´è¯¥çº¿ç¨‹ä¹‹å‰çš„æ—§å‰é©±preNodeå¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨ï¼Œ</span>
            <span class="c1">// æ‰€ä»¥å½“ä¸‹ä¸€æ¬¡ä¼šè¢«GCæ‰ã€‚å› æ­¤åœ¨3ä¸­ä¸ç”¨é‡æ–°åˆ›å»ºæ–°çš„CLHNodeèŠ‚ç‚¹å¯¹è±¡ï¼ŒmyNodeThreadLocal.set(predNodeThreadLocal.get());è¿™å¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œ</span>
            <span class="c1">// æé«˜GCæ•ˆç‡å’ŒèŠ‚çœå†…å­˜ç©ºé—´</span>
            <span class="n">myNode</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">myPred</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">KFC</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CLHLock</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">takeout</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": æ‹¿äº†ç¬¬"</span> <span class="o">+</span> <span class="o">++</span><span class="n">i</span> <span class="o">+</span> <span class="s">"ä»½"</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"----------------------------------------------------------------------------------------"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="no">KFC</span> <span class="n">kfc</span> <span class="o">=</span> <span class="k">new</span> <span class="no">KFC</span><span class="o">();</span>
        <span class="nc">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="nl">kfc:</span><span class="o">:</span><span class="n">takeout</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h5 id="æ‰“å°ç»“æœ">æ‰“å°ç»“æœ</h5>

<blockquote>
  <p>pool-1-thread-2 acquire lock success. myNode(QNode_2_locked:true), myPred(QNode_1_locked:false)<br />
pool-1-thread-2: æ‹¿äº†ç¬¬1ä»½<br />
pool-1-thread-1 acquire lock success. myNode(QNode_3_locked:true), myPred(QNode_2_locked:false)<br />
pool-1-thread-1: æ‹¿äº†ç¬¬2ä»½<br />
pool-1-thread-3 acquire lock success. myNode(QNode_4_locked:true), myPred(QNode_3_locked:false)<br />
pool-1-thread-3: æ‹¿äº†ç¬¬3ä»½<br />
pool-1-thread-4 acquire lock success. myNode(QNode_5_locked:true), myPred(QNode_4_locked:false)<br />
pool-1-thread-4: æ‹¿äº†ç¬¬4ä»½<br />
pool-1-thread-5 acquire lock success. myNode(QNode_6_locked:true), myPred(QNode_5_locked:false)<br />
pool-1-thread-5: æ‹¿äº†ç¬¬5ä»½ <br />
pool-1-thread-2 acquire lock success. myNode(QNode_1_locked:true), myPred(QNode_6_locked:false)<br />
pool-1-thread-2: æ‹¿äº†ç¬¬6ä»½<br />
pool-1-thread-1 acquire lock success. myNode(QNode_2_locked:true), myPred(QNode_1_locked:false)<br />
pool-1-thread-1: æ‹¿äº†ç¬¬7ä»½<br />
pool-1-thread-3 acquire lock success. myNode(QNode_3_locked:true), myPred(QNode_2_locked:false)<br />
pool-1-thread-3: æ‹¿äº†ç¬¬8ä»½<br />
pool-1-thread-4 acquire lock success. myNode(QNode_4_locked:true), myPred(QNode_3_locked:false)<br />
pool-1-thread-4: æ‹¿äº†ç¬¬9ä»½<br />
pool-1-thread-5 acquire lock success. myNode(QNode_5_locked:true), myPred(QNode_4_locked:false)<br />
pool-1-thread-5: æ‹¿äº†ç¬¬10ä»½ <br />
pool-1-thread-2 acquire lock success. myNode(QNode_6_locked:true), myPred(QNode_5_locked:false)<br />
pool-1-thread-2: æ‹¿äº†ç¬¬11ä»½<br />
pool-1-thread-1 acquire lock success. myNode(QNode_1_locked:true), myPred(QNode_6_locked:false)<br />
pool-1-thread-1: æ‹¿äº†ç¬¬12ä»½<br />
pool-1-thread-3 acquire lock success. myNode(QNode_2_locked:true), myPred(QNode_1_locked:false)<br />
pool-1-thread-3: æ‹¿äº†ç¬¬13ä»½<br />
pool-1-thread-4 acquire lock success. myNode(QNode_3_locked:true), myPred(QNode_2_locked:false)<br />
pool-1-thread-4: æ‹¿äº†ç¬¬14ä»½<br />
pool-1-thread-5 acquire lock success. myNode(QNode_4_locked:true), myPred(QNode_3_locked:false)<br />
pool-1-thread-5: æ‹¿äº†ç¬¬15ä»½  <br />
pool-1-thread-2 acquire lock success. myNode(QNode_5_locked:true), myPred(QNode_4_locked:false)<br />
pool-1-thread-2: æ‹¿äº†ç¬¬16ä»½<br />
pool-1-thread-1 acquire lock success. myNode(QNode_6_locked:true), myPred(QNode_5_locked:false)<br />
pool-1-thread-1: æ‹¿äº†ç¬¬17ä»½<br />
pool-1-thread-3 acquire lock success. myNode(QNode_1_locked:true), myPred(QNode_6_locked:false)<br />
pool-1-thread-3: æ‹¿äº†ç¬¬18ä»½<br />
pool-1-thread-4 acquire lock success. myNode(QNode_2_locked:true), myPred(QNode_1_locked:false)<br />
pool-1-thread-4: æ‹¿äº†ç¬¬19ä»½<br />
pool-1-thread-5 acquire lock success. myNode(QNode_3_locked:true), myPred(QNode_2_locked:false)<br />
pool-1-thread-5: æ‹¿äº†ç¬¬20ä»½  <br />
â€¦â€¦.</p>
</blockquote>

<p>æ‰“å°ä¿¡æ¯ä¹ŸéªŒè¯äº†<code class="language-plaintext highlighter-rouge">this.myNodeThreadLocal.set(predNodeThreadLocal.get());</code>å¯ä»¥ä¸ç”¨é‡æ–°åˆ›å»ºæ–°çš„CLHNodeèŠ‚ç‚¹å¯¹è±¡ï¼Œæé«˜GCæ•ˆç‡å’ŒèŠ‚çœå†…å­˜ç©ºé—´</p>
:ET