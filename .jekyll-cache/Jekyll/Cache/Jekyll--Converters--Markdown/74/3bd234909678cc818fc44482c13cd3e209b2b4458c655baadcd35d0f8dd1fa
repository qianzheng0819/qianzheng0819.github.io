I"›Æ<p>èŠ±äº†ä¸€ä¸ªä¸‹åˆæ—¶é—´çœ‹äº†ä¸‹listviewçš„æºç ï¼Œä¹Ÿæœ‰å‚è€ƒä»–äººåšå®¢æ¥æŒ‡å¯¼æ€è·¯ã€‚å­¦ä¹ å°±æ˜¯è¿™æ ·ï¼Œèƒ½å¤ŸåŒ–å¤–ç‰©ä¸ºå·±ç”¨æ˜¯ä¸Šä¸Šæ³•ï¼Œæ¯•ç«Ÿç ”ç©¶ä¸€ä¸ªæœªçŸ¥é¢†åŸŸ
æ˜¯å¾ˆè€—è´¹æ—¶é—´çš„ã€‚ç°åœ¨æ¥åˆ†æä¸€ä¸‹listviewæºç ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•è¿ä½œèµ·æ¥çš„ã€‚è¿™ç¯‡åšå®¢è¿‡åï¼Œå¯èƒ½ä¼šå¼€å§‹å­¦ä¹ å‰ç«¯webçš„çŸ¥è¯†ï¼Œå…³äºandroidæºç çš„åˆ†æ
ä¼šæš‚æ—¶åœä¸‹ã€‚</p>

<p>è¯»è¿‡ViewRootImplçš„performTransversæºç çš„åŒå­¦éƒ½çŸ¥é“ï¼Œä¸€ä¸ªviewè‡³å°‘ä¼šç»å†ä¸¤æ¬¡measureå’Œlayoutçš„è¿‡ç¨‹ã€‚è€Œæˆ‘ä»¬çš„listviewç”±äºè¦åŠ è½½è¾ƒå¤š
çš„view,æ‰€ä»¥å¯¹ä¸¤æ¬¡layoutæ˜¯åšäº†ä¼˜åŒ–çš„ã€‚</p>

<h3 id="ç¬¬ä¸€æ¬¡layout">ç¬¬ä¸€æ¬¡layout</h3>
<p>listviewç»§æ‰¿äºAbsListView,çœ‹ä¸‹å…¶onLayoutæ–¹æ³•</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onLayout</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">changed</span><span class="o">,</span> <span class="kt">int</span> <span class="n">l</span><span class="o">,</span> <span class="kt">int</span> <span class="n">t</span><span class="o">,</span> <span class="kt">int</span> <span class="n">r</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onLayout</span><span class="o">(</span><span class="n">changed</span><span class="o">,</span> <span class="n">l</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
    <span class="n">mInLayout</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">changed</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">childCount</span> <span class="o">=</span> <span class="n">getChildCount</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">forceLayout</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">mRecycler</span><span class="o">.</span><span class="na">markChildrenDirty</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">layoutChildren</span><span class="o">();</span>
    <span class="n">mInLayout</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="n">mOverscrollMax</span> <span class="o">=</span> <span class="o">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">t</span><span class="o">)</span> <span class="o">/</span> <span class="no">OVERSCROLL_LIMIT_DIVISOR</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>æ¥ç€çœ‹listviewçš„layoutChildren()æ–¹æ³•ï¼Œåªå½•äº†å…³é”®ä»£ç </p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">dataChanged</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">recycleBin</span><span class="o">.</span><span class="na">addScrapView</span><span class="o">(</span><span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                        <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">MOVE_TO_SCRAP_HEAP</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">recycleBin</span><span class="o">.</span><span class="na">fillActiveViews</span><span class="o">(</span><span class="n">childCount</span><span class="o">,</span> <span class="n">firstPosition</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// take focus back to us temporarily to avoid the eventual</span>
    <span class="c1">// call to clear focus when removing the focused child below</span>
    <span class="c1">// from messing things up when ViewRoot assigns focus back</span>
    <span class="c1">// to someone else</span>
    <span class="kd">final</span> <span class="nc">View</span> <span class="n">focusedChild</span> <span class="o">=</span> <span class="n">getFocusedChild</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">focusedChild</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// TODO: in some cases focusedChild.getParent() == null</span>

        <span class="c1">// we can remember the focused view to restore after relayout if the</span>
        <span class="c1">// data hasn't changed, or if the focused position is a header or footer</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dataChanged</span> <span class="o">||</span> <span class="n">isDirectChildHeaderOrFooter</span><span class="o">(</span><span class="n">focusedChild</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">focusLayoutRestoreDirectChild</span> <span class="o">=</span> <span class="n">focusedChild</span><span class="o">;</span>
            <span class="c1">// remember the specific view that had focus</span>
            <span class="n">focusLayoutRestoreView</span> <span class="o">=</span> <span class="n">findFocus</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">focusLayoutRestoreView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// tell it we are going to mess with it</span>
                <span class="n">focusLayoutRestoreView</span><span class="o">.</span><span class="na">onStartTemporaryDetach</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">requestFocus</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Clear out old views</span>
    <span class="n">detachAllViewsFromParent</span><span class="o">();</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">mLayoutMode</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">....</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">childCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mStackFromBottom</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="n">lookForSelectablePosition</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="n">setSelectedPositionInt</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillFromTop</span><span class="o">(</span><span class="n">childrenTop</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="n">lookForSelectablePosition</span><span class="o">(</span><span class="n">mItemCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">setSelectedPositionInt</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillUp</span><span class="o">(</span><span class="n">mItemCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">childrenBottom</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mSelectedPosition</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mSelectedPosition</span> <span class="o">&lt;</span> <span class="n">mItemCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="n">mSelectedPosition</span><span class="o">,</span>
                        <span class="n">oldSel</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">childrenTop</span> <span class="o">:</span> <span class="n">oldSel</span><span class="o">.</span><span class="na">getTop</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mFirstPosition</span> <span class="o">&lt;</span> <span class="n">mItemCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="n">mFirstPosition</span><span class="o">,</span>
                        <span class="n">oldFirst</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">childrenTop</span> <span class="o">:</span> <span class="n">oldFirst</span><span class="o">.</span><span class="na">getTop</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">childrenTop</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>dataChangedæ˜¯æ ‡è®°æ•°æ®æºæœ‰å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬èµ°recycleBin.fillActiveViews(childCount, firstPosition)ã€‚ç”±äºç¬¬ä¸€æ¬¡layoutï¼ŒchildCount=0,
æ‰€ä»¥fillActiveViewså¹¶æ²¡æœ‰åšäº‹ã€‚detachAllViewsFromParent()åŒæ ·çš„åŸå› ä¹Ÿä¸ä¼šå¹²äº‹ï¼Œå…·ä½“å¯ä»¥ç‚¹è¿›å»çœ‹æºç ã€‚ <br />
ç¬¬ä¸€æ¬¡layoutçš„å…³é”®ä»£ç æ˜¯sel = fillFromTop(childrenTop)ï¼Œæˆ‘ä»¬ç‚¹è¿›å»çœ‹ä¸€çœ‹ã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">View</span> <span class="nf">fillFromTop</span><span class="o">(</span><span class="kt">int</span> <span class="n">nextTop</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mFirstPosition</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mFirstPosition</span><span class="o">,</span> <span class="n">mSelectedPosition</span><span class="o">);</span>
    <span class="n">mFirstPosition</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">mFirstPosition</span><span class="o">,</span> <span class="n">mItemCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mFirstPosition</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mFirstPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">fillDown</span><span class="o">(</span><span class="n">mFirstPosition</span><span class="o">,</span> <span class="n">nextTop</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">View</span> <span class="nf">fillDown</span><span class="o">(</span><span class="kt">int</span> <span class="n">pos</span><span class="o">,</span> <span class="kt">int</span> <span class="n">nextTop</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">selectedView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="o">(</span><span class="n">mBottom</span> <span class="o">-</span> <span class="n">mTop</span><span class="o">)</span> <span class="o">-</span> <span class="n">mListPadding</span><span class="o">.</span><span class="na">bottom</span><span class="o">;</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">nextTop</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mItemCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// is this the selected item?</span>
        <span class="kt">boolean</span> <span class="n">selected</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">mSelectedPosition</span><span class="o">;</span>
        <span class="nc">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">makeAndAddView</span><span class="o">(</span><span class="n">pos</span><span class="o">,</span> <span class="n">nextTop</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">mListPadding</span><span class="o">.</span><span class="na">left</span><span class="o">,</span> <span class="n">selected</span><span class="o">);</span>

        <span class="n">nextTop</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">getBottom</span><span class="o">()</span> <span class="o">+</span> <span class="n">mDividerHeight</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">selected</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">selectedView</span> <span class="o">=</span> <span class="n">child</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">pos</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">selectedView</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">View</span> <span class="nf">makeAndAddView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flow</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childrenLeft</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">selected</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">child</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">mDataChanged</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Try to use an exsiting view for this position</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">mRecycler</span><span class="o">.</span><span class="na">getActiveView</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">RECYCLE_FROM_ACTIVE_HEAP</span><span class="o">,</span>
                        <span class="n">position</span><span class="o">,</span> <span class="n">getChildCount</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="c1">// Found it -- we're using an existing child</span>
            <span class="c1">// This just needs to be positioned</span>
            <span class="n">setupChild</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">flow</span><span class="o">,</span> <span class="n">childrenLeft</span><span class="o">,</span> <span class="n">selected</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">child</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Make a new view for this position, or convert an unused view if possible</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">obtainView</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">mIsScrap</span><span class="o">);</span>

    <span class="c1">// This needs to be positioned and measured</span>
    <span class="n">setupChild</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">flow</span><span class="o">,</span> <span class="n">childrenLeft</span><span class="o">,</span> <span class="n">selected</span><span class="o">,</span> <span class="n">mIsScrap</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

    <span class="k">return</span> <span class="n">child</span><span class="o">;</span>
<span class="o">}</span>

<span class="nc">View</span> <span class="nf">obtainView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">isScrap</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">isScrap</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">View</span> <span class="n">scrapView</span><span class="o">;</span>

        <span class="n">scrapView</span> <span class="o">=</span> <span class="n">mRecycler</span><span class="o">.</span><span class="na">getScrapView</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>

        <span class="nc">View</span> <span class="n">child</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">scrapView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">scrapView</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">RECYCLE_FROM_SCRAP_HEAP</span><span class="o">,</span>
                        <span class="n">position</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">child</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getView</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">scrapView</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">BIND_VIEW</span><span class="o">,</span>
                        <span class="n">position</span><span class="o">,</span> <span class="n">getChildCount</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">!=</span> <span class="n">scrapView</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mRecycler</span><span class="o">.</span><span class="na">addScrapView</span><span class="o">(</span><span class="n">scrapView</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mCacheColorHint</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">child</span><span class="o">.</span><span class="na">setDrawingCacheBackgroundColor</span><span class="o">(</span><span class="n">mCacheColorHint</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">scrapView</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">MOVE_TO_SCRAP_HEAP</span><span class="o">,</span>
                            <span class="n">position</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">isScrap</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="n">child</span><span class="o">.</span><span class="na">dispatchFinishTemporaryDetach</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">mAdapter</span><span class="o">.</span><span class="na">getView</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCacheColorHint</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">child</span><span class="o">.</span><span class="na">setDrawingCacheBackgroundColor</span><span class="o">(</span><span class="n">mCacheColorHint</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">NEW_VIEW</span><span class="o">,</span>
                        <span class="n">position</span><span class="o">,</span> <span class="n">getChildCount</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">child</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>è¿™äº›å°±æ˜¯æ ¸å¿ƒä»£ç äº†ã€‚ç¬¬ä¸€æ¬¡layoutå°±æ˜¯æ ¹æ®å½“å‰çš„listviewé«˜åº¦æ¥è®¡ç®—æˆ‘ä»¬è¦newå¤šå°‘ä¸ªviewã€‚è¿™ä¸ªæ•°é‡åŸºæœ¬ä¸Šå°±æ˜¯æˆ‘ä»¬listviewæ‰€æœ‰éœ€è¦åˆ›é€ çš„å¯¹è±¡äº†ï¼Œ
è¿™ä¹Ÿæ˜¯å…¶å¤ç”¨çš„æ ¸å¿ƒæ€è·¯ã€‚ç¬¬ä¸€æ¬¡layoutä¼šèµ°child = mAdapter.getView(position, null, this)ã€‚è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„è‡ªå®šä¹‰adapterå¤å†™çš„æ–¹æ³•ï¼Œé‡Œé¢ä¼š
è°ƒç”¨Inflator.inflateæ¥è§£æxmlæ–‡ä»¶ï¼Œè¿™ä¸ªæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚
ä¸‹é¢æˆ‘ä»¬è¿˜å…·ä½“å…³æ³¨ä¸‹ï¼ŒsetupChildæ–¹æ³•ï¼š</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setupChild</span><span class="o">(</span><span class="nc">View</span> <span class="n">child</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flowDown</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childrenLeft</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">selected</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">recycled</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">.....</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">recycled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="na">forceAdd</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">recycledHeaderFooter</span> <span class="o">&amp;&amp;</span>
                <span class="n">p</span><span class="o">.</span><span class="na">viewType</span> <span class="o">==</span> <span class="nc">AdapterView</span><span class="o">.</span><span class="na">ITEM_VIEW_TYPE_HEADER_OR_FOOTER</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">attachViewToParent</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">flowDown</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">p</span><span class="o">.</span><span class="na">forceAdd</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">viewType</span> <span class="o">==</span> <span class="nc">AdapterView</span><span class="o">.</span><span class="na">ITEM_VIEW_TYPE_HEADER_OR_FOOTER</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">p</span><span class="o">.</span><span class="na">recycledHeaderFooter</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">addViewInLayout</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">flowDown</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>

      <span class="o">....</span>
    <span class="o">}</span></code></pre></figure>

<p>å¯ä»¥çœ‹åˆ°recycledä¸ºtrueï¼Œåˆ™attachä¸Šå»ï¼Œè¿™æ˜¯ç¬¬äºŒæ¬¡layoutä¼šèµ°çš„è·¯å¾„ã€‚å¦‚æœrecycledä¸ºfalseï¼Œåˆ™è°ƒç”¨addViewInLayoutæ¥ç»™listviewæ·»åŠ å­view,
è¿™æ˜¯ç¬¬ä¸€æ¬¡layoutä¼šèµ°çš„è·¯å¾„ã€‚</p>

<p>æ¥ä¸‹æ¥çœ‹çœ‹ç¬¬äºŒæ¬¡layoutçš„è¿‡ç¨‹</p>

<h3 id="ç¬¬äºŒæ¬¡layout">ç¬¬äºŒæ¬¡layout</h3>
<p>å…¶å®ç¬¬äºŒæ¬¡layoutçš„ä»£ç å’Œç¬¬ä¸€æ¬¡æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯ä»£ç çš„è·¯å¾„åˆ†æ”¯ä¸ä¸€æ ·ã€‚æˆ‘ä»¬çœ‹ä¸‹listviewæ˜¯å¦‚ä½•è®¾è®¡ï¼Œæ¥é¿å…ä¸¤æ¬¡layouté‡å¤è§£æxmlæ–‡ä»¶å’Œæ·»åŠ å­viewã€‚</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">dataChanged</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">recycleBin</span><span class="o">.</span><span class="na">addScrapView</span><span class="o">(</span><span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">),</span>
                        <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">MOVE_TO_SCRAP_HEAP</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">recycleBin</span><span class="o">.</span><span class="na">fillActiveViews</span><span class="o">(</span><span class="n">childCount</span><span class="o">,</span> <span class="n">firstPosition</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// take focus back to us temporarily to avoid the eventual</span>
    <span class="c1">// call to clear focus when removing the focused child below</span>
    <span class="c1">// from messing things up when ViewRoot assigns focus back</span>
    <span class="c1">// to someone else</span>
    <span class="kd">final</span> <span class="nc">View</span> <span class="n">focusedChild</span> <span class="o">=</span> <span class="n">getFocusedChild</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">focusedChild</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// TODO: in some cases focusedChild.getParent() == null</span>

        <span class="c1">// we can remember the focused view to restore after relayout if the</span>
        <span class="c1">// data hasn't changed, or if the focused position is a header or footer</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dataChanged</span> <span class="o">||</span> <span class="n">isDirectChildHeaderOrFooter</span><span class="o">(</span><span class="n">focusedChild</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">focusLayoutRestoreDirectChild</span> <span class="o">=</span> <span class="n">focusedChild</span><span class="o">;</span>
            <span class="c1">// remember the specific view that had focus</span>
            <span class="n">focusLayoutRestoreView</span> <span class="o">=</span> <span class="n">findFocus</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">focusLayoutRestoreView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// tell it we are going to mess with it</span>
                <span class="n">focusLayoutRestoreView</span><span class="o">.</span><span class="na">onStartTemporaryDetach</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">requestFocus</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Clear out old views</span>
    <span class="n">detachAllViewsFromParent</span><span class="o">();</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">mLayoutMode</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">....</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">childCount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mStackFromBottom</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="n">lookForSelectablePosition</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="n">setSelectedPositionInt</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillFromTop</span><span class="o">(</span><span class="n">childrenTop</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="n">lookForSelectablePosition</span><span class="o">(</span><span class="n">mItemCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="n">setSelectedPositionInt</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillUp</span><span class="o">(</span><span class="n">mItemCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">childrenBottom</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mSelectedPosition</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mSelectedPosition</span> <span class="o">&lt;</span> <span class="n">mItemCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="n">mSelectedPosition</span><span class="o">,</span>
                        <span class="n">oldSel</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">childrenTop</span> <span class="o">:</span> <span class="n">oldSel</span><span class="o">.</span><span class="na">getTop</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mFirstPosition</span> <span class="o">&lt;</span> <span class="n">mItemCount</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="n">mFirstPosition</span><span class="o">,</span>
                        <span class="n">oldFirst</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">childrenTop</span> <span class="o">:</span> <span class="n">oldFirst</span><span class="o">.</span><span class="na">getTop</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">fillSpecific</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">childrenTop</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span></code></pre></figure>

<p>è¿™æ¬¡ä¼šèµ°recycleBin.fillActiveViews(childCount, firstPosition);ç‚¹è¿›å»çœ‹ä¸‹æºç </p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">fillActiveViews</span><span class="o">(</span><span class="kt">int</span> <span class="n">childCount</span><span class="o">,</span> <span class="kt">int</span> <span class="n">firstActivePosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mActiveViews</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mActiveViews</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">View</span><span class="o">[</span><span class="n">childCount</span><span class="o">];</span>
    <span class="o">}</span>
    <span class="n">mFirstActivePosition</span> <span class="o">=</span> <span class="n">firstActivePosition</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">View</span><span class="o">[]</span> <span class="n">activeViews</span> <span class="o">=</span> <span class="n">mActiveViews</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">childCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="nc">AbsListView</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">lp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">AbsListView</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span> <span class="n">child</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
        <span class="c1">// Don't put header or footer views into the scrap heap</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">.</span><span class="na">viewType</span> <span class="o">!=</span> <span class="no">ITEM_VIEW_TYPE_HEADER_OR_FOOTER</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Note:  We do place AdapterView.ITEM_VIEW_TYPE_IGNORE in active views.</span>
            <span class="c1">//        However, we will NOT place them into scrap views.</span>
            <span class="n">activeViews</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">child</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>ä¸€çœ¼å°±èƒ½çœ‹æ˜ç™½ï¼Œä½œç”¨å°±æ˜¯æ ¹æ®å½“å‰å­viewçš„æ•°é‡ï¼Œåˆå§‹åŒ–äº†mActiveViewsï¼Œå¹¶ä¸”ç”¨å®ƒæ¥è®°å½•è¿™äº›child viewã€‚</p>

<p>å†çœ‹detachAllViewsFromParent()</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">detachAllViewsFromParent</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mChildrenCount</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="nc">View</span><span class="o">[]</span> <span class="n">children</span> <span class="o">=</span> <span class="n">mChildren</span><span class="o">;</span>
        <span class="n">mChildrenCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span> <span class="o">{</span>
            <span class="n">children</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">mParent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">children</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre></figure>

<p>ä¹Ÿå¾ˆç®€å•ï¼ŒmChildrenCountç½®0ï¼Œchild.Parentç½®ç©º</p>

<p>æ¥ç€è¿˜æ˜¯èµ°sel = fillFromTop(childrenTop);æˆ‘ä»¬ç›´æ¥çœ‹</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="nc">View</span> <span class="nf">makeAndAddView</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flow</span><span class="o">,</span> <span class="kt">int</span> <span class="n">childrenLeft</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">selected</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">child</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">mDataChanged</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Try to use an exsiting view for this position</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">mRecycler</span><span class="o">.</span><span class="na">getActiveView</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ViewDebug</span><span class="o">.</span><span class="na">TRACE_RECYCLER</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="nc">ViewDebug</span><span class="o">.</span><span class="na">RecyclerTraceType</span><span class="o">.</span><span class="na">RECYCLE_FROM_ACTIVE_HEAP</span><span class="o">,</span>
                        <span class="n">position</span><span class="o">,</span> <span class="n">getChildCount</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="c1">// Found it -- we're using an existing child</span>
            <span class="c1">// This just needs to be positioned</span>
            <span class="n">setupChild</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">flow</span><span class="o">,</span> <span class="n">childrenLeft</span><span class="o">,</span> <span class="n">selected</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

            <span class="k">return</span> <span class="n">child</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// Make a new view for this position, or convert an unused view if possible</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">obtainView</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">mIsScrap</span><span class="o">);</span>

    <span class="c1">// This needs to be positioned and measured</span>
    <span class="n">setupChild</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">flow</span><span class="o">,</span> <span class="n">childrenLeft</span><span class="o">,</span> <span class="n">selected</span><span class="o">,</span> <span class="n">mIsScrap</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>

    <span class="k">return</span> <span class="n">child</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>child = mRecycler.getActiveView(position)è¿™ä¸€æ¬¡å°±æœ‰å€¼äº†ï¼Œè°ƒç”¨setupChild,å…¶recycledå‚æ•°ä¸ºtrue,è¿›å»åªæ‰§è¡Œattachæ“ä½œã€‚</p>

<h3 id="æœ€åçš„æ€»ç»“">æœ€åçš„æ€»ç»“</h3>
<p>listviewçš„ç²¾åå¯ä»¥è¯´æ˜¯åœ¨RecycleBinç±»é‡Œçš„ä¸¤ä¸ªæ•°ç»„ï¼ŒmActiveViewså’ŒmScrapViews.<br />
mActiveViewsçš„è®¾è®¡ï¼Œå…¶ä¸­å­viewç»è¿‡äº†attachâ€“detachâ€“attachçš„è¿‡ç¨‹ï¼Œå·§å¦™çš„é¿å…äº†ä¸¤æ¬¡layouté‡å¤è§£æxmlå’Œæ·»åŠ å­viewçš„é—®é¢˜ï¼Œæé«˜äº† <br />
listviewçš„æ€§èƒ½ã€‚
mScrapViewsçš„è®¾è®¡æˆ‘ä»¬æ²¡æœ‰è¿‡å¤šè®²è§£ï¼Œå…¶åŸå› æ˜¯å…¶æ¯”è¾ƒç®€å•å¥½ä¸ºç†è§£ã€‚ä½œç”¨å°±æ˜¯èµ·åˆ°äº†å­viewçš„å¤ç”¨ï¼Œæ¯å½“æœ‰å­viewæ»‘å‡ºlistviewçš„èŒƒå›´ï¼Œè¯¥viewå°±
ä¼šå…¥æ ˆmScrapViewsï¼ŒåŒæ—¶æˆ‘ä»¬è°ƒç”¨obtainViewè·å–æ–°viewï¼Œå°±æ˜¯ä»mScrapViewså‡ºæ ˆã€‚</p>
:ET