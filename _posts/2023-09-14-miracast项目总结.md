---
layout: post
title:  "miracast项目总结"
date:   2023-09-14 10:40:00 +0800
tags:   音视频开发
description:
---

先上流程图
-----------         

![p](/assets/images/2023-pic/p3.png)        


RTP包的处理
-------------

```
status_t RTPReceiver::onRTPData(const sp<ABuffer> &buffer) {
    size_t size = buffer->size();
    if (size < 12) {
        // Too short to be a valid RTP header.
        return ERROR_MALFORMED;
    }

    ...

    // set buffer start point to CSRC header
    buffer->setRange(payloadOffset, size - payloadOffset);

    ssize_t index = mSources.indexOfKey(srcId);
    sp<Source> source;
    if (index < 0) {
        source = new Source(this, srcId);
        looper()->registerHandler(source);

        mSources.add(srcId, source);
    } else {
        source = mSources.valueAt(index);
    }

    source->onPacketReceived(seqNo, buffer);

    return OK;
}
```

上面的代码主要涉及到rtp协议的解析，本项目的重点不在rtp协议，所以略过。   
`buffer->setRange(payloadOffset, size - payloadOffset)`意思是拿到了负载offset    
接着看下面的`source->onPacketReceived()`方法中的`queuePacket()方法`

```
void RTPReceiver::Source::queuePacket(const sp<ABuffer> &packet) {
    int32_t newExtendedSeqNo = packet->int32Data();

    if (mFirstArrivalTimeUs < 0ll) {
        // 记录第一个Rtp包到达时间
        mFirstArrivalTimeUs = ALooper::GetNowUs(); 

        // 获取rtp包的时间戳
        uint32_t rtpTime;
        CHECK(packet->meta()->findInt32("rtp-time", (int32_t *)&rtpTime));

        mFirstRTPTimeUs = (rtpTime * 100ll) / 9ll;
        ALOGV("%s first rtp time: %lld; first arrive time: %lld.", __FUNCTION__, mFirstRTPTimeUs, mFirstArrivalTimeUs);
    }

    if (mAwaitingExtSeqNo >= 0 && newExtendedSeqNo < mAwaitingExtSeqNo) {
        // We're no longer interested in these. They're old.
        ALOGD("queuePacket: dropping stale extSeqNo %d", newExtendedSeqNo);

        modifyPacketStatus(newExtendedSeqNo, STATUS_ARRIVED_LATE);
        return;
    }

    if (mPackets.empty()) {
        mPackets.push_back(packet);
        dequeueMore();
        return;
    }
    //if mPackets is not empty, we should insert the new package into the right position
    List<sp<ABuffer> >::iterator firstIt = mPackets.begin();
    List<sp<ABuffer> >::iterator it = --mPackets.end();
    for (;;) {
        int32_t extendedSeqNo = (*it)->int32Data();

        if (extendedSeqNo == newExtendedSeqNo) {
            // Duplicate packet.
            ALOGD("queuePacket: dropping Duplicate packet. extSeqNo %d", newExtendedSeqNo);
            return;
        }

        if (extendedSeqNo < newExtendedSeqNo) {
            // Insert new packet after the one at "it".
            mPackets.insert(++it, packet);
            break;
        }

        if (it == firstIt) {
            // Insert new packet before the first existing one.
            mPackets.insert(it, packet);
            break;
        }

        --it;
    }

    dequeueMore();
}
```
